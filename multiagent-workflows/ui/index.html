<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Workflow Runner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d12;
            --bg-secondary: #16161d;
            --bg-tertiary: #1e1e28;
            --bg-card: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --accent-dim: rgba(139, 92, 246, 0.2);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.2);
            --blue: #3b82f6;
            --border: #2d2d3a;
            --radius: 12px;
            --radius-sm: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .app { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px 12px; display: flex; flex-direction: column; }
        .logo { display: flex; align-items: center; gap: 10px; padding: 8px 12px 20px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #06b6d4); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .logo-text { font-weight: 700; font-size: 14px; }
        
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-sm); color: var(--text-secondary); text-decoration: none; margin-bottom: 4px; font-size: 14px; transition: all 0.2s; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-item svg { width: 18px; height: 18px; }
        
        .sidebar-footer { margin-top: auto; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); text-align: center; }
        .selection-count { font-size: 20px; font-weight: 700; color: var(--accent); }
        .selection-label { display: block; font-size: 11px; color: var(--text-muted); }
        
        /* Main Content */
        .main-content { flex: 1; padding: 24px 32px; overflow-y: auto; background: radial-gradient(ellipse at top right, rgba(139,92,246,0.05) 0%, transparent 50%); }
        
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; }
        .header-right { display: flex; gap: 10px; }

        .status-pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-tertiary); font-size: 12px; color: var(--text-secondary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        .status-dot.ok { background: var(--green); }
        .status-dot.bad { background: #ef4444; }
        
        .btn { padding: 8px 16px; border-radius: var(--radius-sm); font-weight: 500; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; font-size: 13px; }
        .btn svg { width: 16px; height: 16px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-green { background: var(--green); color: white; }
        .btn-green:hover { background: #16a34a; }
        .btn-large { padding: 12px 24px; font-size: 14px; }
        
        /* Toolbar */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap; }
        .search-filter { display: flex; gap: 8px; flex: 1; max-width: 400px; }
        .search-box { display: flex; align-items: center; gap: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px; flex: 1; }
        .search-box svg { width: 16px; height: 16px; color: var(--text-muted); }
        .search-box input { background: none; border: none; color: var(--text-primary); outline: none; width: 100%; font-size: 13px; }
        .filter-btn { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; }
        .filter-btn svg { width: 14px; height: 14px; }
        
        .toolbar-right { display: flex; align-items: center; gap: 16px; }
        .sort-select { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 13px; }
        .toggle-switch { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .toggle { width: 40px; height: 22px; background: var(--bg-tertiary); border-radius: 11px; cursor: pointer; position: relative; transition: background 0.2s; }
        .toggle.active { background: var(--accent); }
        .toggle::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.2s; }
        .toggle.active::after { left: 20px; }
        
        /* Dataset Cards */
        .dataset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
        .dataset-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; transition: all 0.2s; position: relative; }
        .dataset-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .dataset-card.selected { border-color: var(--green); background: rgba(34, 197, 94, 0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { font-weight: 600; font-size: 15px; }
        .card-icon { width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 18px; }
        .card-tags { display: flex; gap: 6px; margin-bottom: 10px; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .tag-easy { background: var(--green-dim); color: var(--green); }
        .tag-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .tag-hard { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .tag-python { background: var(--accent-dim); color: var(--accent); }
        .card-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .view-details-btn { width: 100%; padding: 8px; background: var(--accent); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s; }
        .view-details-btn:hover { background: var(--accent-hover); }
        
        /* Config Page */
        .config-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
        .config-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; }
        
        /* Workflow Pipeline */
        .pipeline { padding: 20px 0; }
        .pipeline-flow { display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
        .pipeline-agent { flex: 1; min-width: 120px; max-width: 160px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; transition: all 0.2s; }
        .pipeline-agent:hover { border-color: var(--accent); }
        .agent-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .agent-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: white; }
        .agent-name { font-size: 11px; font-weight: 600; }
        .agent-select { width: 100%; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: var(--radius-sm); font-size: 11px; }
        .pipeline-arrow { color: var(--accent); font-size: 18px; flex-shrink: 0; }
        
        .feedback-loops { margin-top: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border: 1px dashed var(--accent); border-radius: var(--radius-sm); }
        .feedback-loop { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .feedback-loop:not(:last-child) { border-bottom: 1px solid var(--border); }
        .feedback-arrow { color: var(--accent); font-size: 16px; }
        .feedback-label { font-size: 12px; color: var(--text-secondary); }
        
        /* Evaluation Settings */
        .eval-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .eval-left, .eval-right { display: flex; flex-direction: column; gap: 16px; }
        
        .slider-group { }
        .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .slider-value { background: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .slider { width: 100%; height: 6px; -webkit-appearance: none; background: var(--bg-tertiary); border-radius: 3px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        
        .number-input { display: flex; align-items: center; gap: 0; }
        .num-btn { width: 32px; height: 32px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .num-btn:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
        .num-btn:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
        .number-input input { width: 40px; height: 32px; text-align: center; background: var(--bg-tertiary); border: 1px solid var(--border); border-left: none; border-right: none; color: var(--text-primary); font-size: 13px; }
        
        /* Scoring Options */
        .scoring-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .total-score { font-size: 18px; font-weight: 700; }
        .score-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .score-checkbox { width: 16px; height: 16px; accent-color: var(--accent); }
        .score-label { flex: 1; font-size: 13px; }
        .score-slider { flex: 2; height: 4px; -webkit-appearance: none; background: linear-gradient(to right, var(--accent) 0%, var(--bg-tertiary) 0%); border-radius: 2px; }
        .score-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .score-value { width: 40px; text-align: right; font-size: 13px; color: var(--text-secondary); }
        
        /* Output Settings */
        .output-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; }
        .output-field label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .output-field input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 13px; }
        .format-btns { display: flex; gap: 8px; }
        .format-btn { padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .format-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        /* Workflow Selector */
        .workflow-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .workflow-option input { display: none; }
        .workflow-card { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
        .workflow-option input:checked + .workflow-card { border-color: var(--accent); background: var(--accent-dim); }
        .workflow-card:hover { border-color: var(--accent); }
        .workflow-icon { font-size: 28px; }
        .workflow-info { flex: 1; }
        .workflow-name { display: block; font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .workflow-desc { display: block; font-size: 12px; color: var(--text-muted); }
        
        /* Run Page */
        .run-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .selected-list { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; height: fit-content; max-height: 500px; overflow-y: auto; }
        .selected-list h3 { font-size: 14px; margin-bottom: 12px; }
        .selected-item { background: var(--bg-tertiary); border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
        .selected-item:hover { background: var(--bg-primary); }
        .selected-item:hover .item-tooltip { display: block; }
        .item-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .item-tags { display: flex; gap: 4px; }
        .item-tooltip { display: none; position: absolute; left: 100%; top: 0; margin-left: 12px; width: 280px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .tooltip-title { font-weight: 600; margin-bottom: 8px; }
        .tooltip-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
        
        .run-details { display: flex; flex-direction: column; gap: 16px; }
        .config-summary { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .config-summary h3 { margin-bottom: 16px; }
        .config-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .config-row:last-child { border-bottom: none; }
        .config-label { color: var(--text-secondary); }
        .config-value { font-weight: 500; }
        
        .metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; }
        .metric-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .metric-value { font-size: 32px; font-weight: 700; color: var(--accent); }
        .metric-icon { font-size: 24px; margin-bottom: 8px; }
        
        .run-actions { display: flex; gap: 12px; }
        .run-actions .btn { flex: 1; justify-content: center; }
        
        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        .pagination-info { font-size: 13px; color: var(--text-secondary); }
        .page-btns { display: flex; gap: 4px; }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; font-size: 13px; }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--text-primary); }
        .page-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        @media (max-width: 1000px) {
            .run-layout { grid-template-columns: 1fr; }
            .pipeline { flex-wrap: wrap; }
            .eval-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) { .sidebar { display: none; } }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; animation: modalIn 0.2s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--accent); color: white; }
        .modal-body { padding: 20px; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-muted); font-size: 13px; }
        .detail-value { font-size: 13px; font-weight: 500; text-align: right; max-width: 60%; }
        .detail-section { margin-top: 16px; }
        .detail-section-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--accent); }
        .example-block { background: var(--bg-tertiary); border-radius: var(--radius-sm); padding: 12px; font-family: monospace; font-size: 12px; white-space: pre-wrap; overflow-x: auto; }
        .example-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
        
        /* Dashboard Styles */
        .dashboard-layout { display: grid; grid-template-columns: 240px 1fr 320px; gap: 0; height: calc(100vh - 120px); }
        .dash-sidebar { background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .dash-sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dash-sidebar-header h3 { font-size: 13px; color: var(--text-secondary); }
        .dash-run-list { flex: 1; overflow-y: auto; }
        .dash-run-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .dash-run-item:hover { background: var(--bg-tertiary); }
        .dash-run-item.active { background: var(--accent-dim); border-left: 3px solid var(--accent); }
        .dash-run-item .name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
        .dash-run-item .time { font-size: 11px; color: var(--text-muted); }
        .dash-run-item .status { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 4px; }
        .dash-run-item .status.running { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .dash-run-item .status.complete { background: var(--green-dim); color: var(--green); }
        .dash-run-item .status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .dash-main { padding: 20px; overflow-y: auto; }
        .dash-run-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .dash-run-info h2 { font-size: 20px; margin-bottom: 8px; }
        .dash-meta { display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary); }
        .dash-status-badge { padding: 4px 10px; border-radius: 6px; font-weight: 600; }
        .dash-status-badge.running { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .dash-status-badge.complete { background: var(--green-dim); color: var(--green); }
        .dash-status-badge.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .dash-live-indicator { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
        .live-pulse { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } }
        
        .dash-pipeline { display: flex; flex-direction: column; gap: 12px; }
        .dash-step { display: flex; align-items: center; gap: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 18px; cursor: pointer; transition: all 0.2s; }
        .dash-step:hover { border-color: var(--accent); transform: translateX(4px); }
        .dash-step.active { border-color: var(--accent); box-shadow: 0 0 20px rgba(139, 92, 246, 0.2); }
        .dash-step-num { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
        .dash-step.pending .dash-step-num { background: var(--bg-tertiary); color: var(--text-muted); }
        .dash-step.running .dash-step-num { background: var(--blue); color: white; animation: pulse 1s infinite; }
        .dash-step.complete .dash-step-num { background: var(--green); color: white; }
        .dash-step.error .dash-step-num { background: #ef4444; color: white; }
        .dash-step-info { flex: 1; }
        .dash-step-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .dash-step-meta { display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); }
        .dash-model-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .dash-model-badge.speed { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .dash-model-badge.power { background: rgba(245, 175, 25, 0.2); color: #f5af19; }
        .dash-model-badge.balanced { background: var(--green-dim); color: var(--green); }
        .dash-step-duration { font-size: 13px; color: var(--text-muted); }
        
        .dash-detail { background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .dash-detail-header { padding: 16px; border-bottom: 1px solid var(--border); }
        .dash-detail-header h3 { font-size: 14px; margin-bottom: 4px; }
        .dash-agent-name { font-size: 12px; color: var(--text-muted); }
        .dash-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .dash-tab { flex: 1; padding: 10px; text-align: center; font-size: 12px; color: var(--text-secondary); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .dash-tab:hover { color: var(--text-primary); }
        .dash-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .dash-content { flex: 1; padding: 16px; overflow-y: auto; }
        .dash-output { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; }
        .dash-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .dash-stat { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
        .dash-stat label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; display: block; }
        .dash-stat .value { font-size: 18px; font-weight: 700; margin-top: 4px; color: var(--accent); }
        .dash-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 13px; text-align: center; padding: 40px; }
        
        /* Multi-Workflow Grid View */
        .dash-view-toggle { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; }
        .dash-view-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .dash-view-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--text-primary); }
        .dash-view-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .dash-view-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .dash-live-badge { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
        
        .dash-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .dash-section-header h3 { font-size: 14px; color: var(--text-secondary); }
        .dash-count { background: var(--accent-dim); color: var(--accent); padding: 2px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; }
        
        .dash-workflow-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .dash-workflow-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .dash-workflow-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); }
        .dash-workflow-card.running { border-left: 3px solid var(--blue); }
        .dash-workflow-card.running::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--blue), var(--accent)); animation: progress-shimmer 1.5s ease-in-out infinite; }
        @keyframes progress-shimmer { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .dash-workflow-card.complete { border-left: 3px solid var(--green); }
        .dash-workflow-card.error { border-left: 3px solid #ef4444; }
        
        .dash-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .dash-card-title { font-weight: 600; font-size: 15px; }
        .dash-card-time { font-size: 11px; color: var(--text-muted); }
        .dash-card-status { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .dash-card-status.running { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .dash-card-status.complete { background: var(--green-dim); color: var(--green); }
        .dash-card-status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .dash-card-progress { margin-bottom: 12px; }
        .dash-progress-bar { height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
        .dash-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--blue)); border-radius: 2px; transition: width 0.3s ease; }
        .dash-progress-text { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: var(--text-muted); }
        
        .dash-card-steps { display: flex; gap: 4px; flex-wrap: wrap; }
        .dash-mini-step { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
        .dash-mini-step.pending { background: var(--bg-tertiary); color: var(--text-muted); }
        .dash-mini-step.running { background: var(--blue); color: white; animation: pulse 1s infinite; }
        .dash-mini-step.complete { background: var(--green); color: white; }
        .dash-mini-step.error { background: #ef4444; color: white; }
        
        .dash-back-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px; cursor: pointer; margin-bottom: 16px; transition: all 0.2s; }
        .dash-back-btn:hover { background: var(--accent); border-color: var(--accent); }
        
        /* Agent Roster Styles */
        .agents-header { margin-bottom: 24px; }
        .agents-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .agents-title-row h2 { font-size: 22px; }
        .agents-actions { display: flex; gap: 12px; }
        .agents-actions .btn { display: flex; align-items: center; gap: 6px; }
        .agents-subtitle { color: var(--text-muted); font-size: 14px; }
        
        .model-chips { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 0; }
        .model-chip { padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 20px; font-size: 12px; color: var(--text-secondary); transition: all 0.2s; }
        .model-chip.online { border-color: var(--green); color: var(--green); }
        .model-chip.offline { border-color: #ef4444; color: #ef4444; opacity: 0.6; }
        .model-chip.loading { animation: pulse 1s infinite; }
        .model-count { font-size: 12px; color: var(--accent); font-weight: 600; }
        
        .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
        .agent-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; transition: all 0.2s; }
        .agent-card:hover { border-color: var(--accent); }
        .agent-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .agent-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .agent-icon.coordinator { background: linear-gradient(135deg, #667eea, #764ba2); }
        .agent-icon.analyst { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .agent-icon.developer { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .agent-icon.reviewer { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .agent-icon.default { background: linear-gradient(135deg, var(--accent), var(--blue)); }
        .agent-name { font-weight: 600; font-size: 15px; margin-top: 4px; }
        .agent-role { font-size: 12px; color: var(--text-muted); }
        .agent-status { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .agent-status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .agent-status-dot.ready { background: var(--green); }
        .agent-status-dot.busy { background: var(--blue); animation: pulse 1s infinite; }
        
        .agent-config { margin-top: 12px; }
        .agent-config-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .agent-config-row:last-child { border-bottom: none; }
        .agent-config-label { font-size: 12px; color: var(--text-muted); }
        .agent-config-value { font-size: 12px; font-weight: 500; }
        .agent-model-select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; font-size: 12px; color: var(--text-primary); min-width: 180px; cursor: pointer; }
        .agent-model-select:focus { border-color: var(--accent); outline: none; }
        
        @media (max-width: 1200px) { .dashboard-layout { grid-template-columns: 200px 1fr; } .dash-detail { display: none; } }
    </style>
</head>
<body>
    <!-- Details Modal -->
    <div class="modal-overlay" id="detailsModal" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Dataset Details</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="logo"><div class="logo-icon">‚ö°</div><span class="logo-text">Workflow Runner</span></div>
            <nav>
                <a href="#" class="nav-item active" data-section="datasets"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>Datasets</span></a>
                <a href="#" class="nav-item" data-section="configuration"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><span>Configuration</span></a>
                <a href="#" class="nav-item" data-section="run"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg><span>Run Workflow</span></a>
                <a href="#" class="nav-item" data-section="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg><span>Live Dashboard</span></a>
                <a href="#" class="nav-item" data-section="agents"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg><span>Agents</span></a>
            </nav>
            <div class="sidebar-footer"><span class="selection-count" id="selCount">0</span><span class="selection-label">items selected</span></div>
        </aside>

        <main class="main-content">
            <header class="header">
                <div><h1 class="page-title" id="pageTitle">Select Datasets</h1><p class="page-subtitle" id="pageSub">Choose evaluation datasets</p></div>
                <div class="header-right">
                    <div class="status-pill" title="Local API server status">
                        <span class="status-dot" id="apiDot"></span>
                        <span id="apiText">API: checking‚Ä¶</span>
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="copyServerCommand()">Copy start cmd</button>
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="checkApiNow(true)">Reconnect</button>
                    </div>
                    <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                    <button class="btn btn-primary" id="nextBtn">Next ‚Üí</button>
                </div>
            </header>

            <!-- DATASETS -->
            <section id="datasets-section" class="content-section active">
                <div class="toolbar">
                    <div class="search-filter">
                        <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input type="text" id="searchInput" placeholder="Search datasets..." oninput="state.page=1;render()"></div>
                        <select class="sort-select" id="filterSource" onchange="state.page=1;render()">
                            <option value="">All Sources</option>
                            <option value="HumanEval">üêç HumanEval</option>
                            <option value="MBPP">üìò MBPP</option>
                            <option value="SWE-bench">üîß SWE-bench</option>
                            <option value="Custom">üìÅ Custom</option>
                        </select>
                        <select class="sort-select" id="filterDifficulty" onchange="state.page=1;render()">
                            <option value="">All Difficulties</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="toolbar-right">
                        <select class="sort-select" id="sortBy" onchange="render()">
                            <option value="default">Sort: Default</option>
                            <option value="name">Sort: Name A-Z</option>
                            <option value="name-desc">Sort: Name Z-A</option>
                            <option value="difficulty">Sort: Difficulty</option>
                            <option value="source">Sort: Source</option>
                        </select>
                        <div class="toggle-switch"><span>Select All</span><div class="toggle" id="selectAllToggle" onclick="toggleSelectAll()"></div></div>
                    </div>
                </div>
                <div id="datasetContainer" class="dataset-grid"></div>
                <div class="pagination">
                    <div class="pagination-info">Showing <span id="showStart">1</span>-<span id="showEnd">8</span> of <span id="totalItems">0</span></div>
                    <div class="page-btns" id="pageButtons"></div>
                </div>
            </section>

            <!-- CONFIGURATION -->
            <section id="configuration-section" class="content-section">
                <div class="config-section">
                    <div class="config-title">Select Workflow</div>
                    <div class="workflow-selector">
                        <label class="workflow-option">
                            <input type="radio" name="workflow" value="fullstack" checked onchange="updatePipeline()">
                            <div class="workflow-card">
                                <span class="workflow-icon">üöÄ</span>
                                <div class="workflow-info">
                                    <span class="workflow-name">Full-Stack Generation</span>
                                    <span class="workflow-desc">Generate complete applications from requirements</span>
                                </div>
                            </div>
                        </label>
                        <label class="workflow-option">
                            <input type="radio" name="workflow" value="refactoring" onchange="updatePipeline()">
                            <div class="workflow-card">
                                <span class="workflow-icon">üîÑ</span>
                                <div class="workflow-info">
                                    <span class="workflow-name">Legacy Refactoring</span>
                                    <span class="workflow-desc">Modernize and refactor legacy codebases</span>
                                </div>
                            </div>
                        </label>
                        <label class="workflow-option">
                            <input type="radio" name="workflow" value="bugfix" onchange="updatePipeline()">
                            <div class="workflow-card">
                                <span class="workflow-icon">üêõ</span>
                                <div class="workflow-info">
                                    <span class="workflow-name">Bug Triage & Fix</span>
                                    <span class="workflow-desc">Analyze, prioritize and fix bugs automatically</span>
                                </div>
                            </div>
                        </label>
                        <label class="workflow-option">
                            <input type="radio" name="workflow" value="architecture" onchange="updatePipeline()">
                            <div class="workflow-card">
                                <span class="workflow-icon">üèóÔ∏è</span>
                                <div class="workflow-info">
                                    <span class="workflow-name">Architecture Evolution</span>
                                    <span class="workflow-desc">Assess technical debt and evolve architecture</span>
                                </div>
                            </div>
                        </label>
                        <label class="workflow-option">
                            <input type="radio" name="workflow" value="repo_maintenance" onchange="updatePipeline()">
                            <div class="workflow-card">
                                <span class="workflow-icon">üìö</span>
                                <div class="workflow-info">
                                    <span class="workflow-name">Repository Maintenance</span>
                                    <span class="workflow-desc">LATS-verified cleanup, testing, and documentation audit</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-title">Agent Pipeline</div>
                    <div class="pipeline" id="pipelineContainer">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="eval-grid">
                    <div class="config-section">
                        <div class="config-title">Evaluation Settings</div>
                        <div class="slider-group">
                            <div class="slider-label"><span>Pass Threshold ‚ìò</span><span class="slider-value" id="threshVal">70%</span></div>
                            <input type="range" class="slider" id="threshold" min="50" max="100" value="70" oninput="document.getElementById('threshVal').textContent=this.value+'%'">
                        </div>
                        <div style="margin-top:16px">
                            <div class="slider-label"><span>Number of Runs</span></div>
                            <div class="number-input"><button class="num-btn" onclick="adjustRuns(-1)">‚àí</button><input type="number" id="numRuns" value="1" min="1" max="10"><button class="num-btn" onclick="adjustRuns(1)">+</button></div>
                        </div>
                        <div style="margin-top:16px">
                            <div class="slider-label"><span>Entry Match ‚ìò</span></div>
                            <select class="agent-select" id="matchType"><option>Fuzzy Match</option><option>Exact Match</option><option>Semantic</option></select>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="scoring-header"><div class="config-title" style="margin:0">Scoring Options</div><span class="total-score">Total Score: <span id="totalScore">70%</span></span></div>
                        <div id="scoringOptions"></div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-title">Logging & Response Verbosity</div>
                    <div class="output-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="output-field">
                            <label>Log Level</label>
                            <select class="agent-select" id="logLevel">
                                <option value="ERROR">Error Only</option>
                                <option value="WARNING">Warning</option>
                                <option value="INFO" selected>Info (Standard)</option>
                                <option value="DEBUG">Debug (Verbose)</option>
                                <option value="TRACE">Trace (All)</option>
                            </select>
                        </div>
                        <div class="output-field">
                            <label>Response Detail</label>
                            <select class="agent-select" id="responseDetail">
                                <option value="minimal">Minimal (Pass/Fail)</option>
                                <option value="summary" selected>Summary</option>
                                <option value="detailed">Detailed</option>
                                <option value="full">Full (Raw Output)</option>
                            </select>
                        </div>
                        <div class="output-field">
                            <label>Include in Output</label>
                            <div class="format-btns" style="flex-wrap:wrap;">
                                <button class="format-btn active" onclick="toggleFormat(this)">Scores</button>
                                <button class="format-btn active" onclick="toggleFormat(this)">Traces</button>
                                <button class="format-btn" onclick="toggleFormat(this)">Tokens</button>
                                <button class="format-btn" onclick="toggleFormat(this)">Timing</button>
                            </div>
                        </div>
                        <div class="output-field">
                            <label>Agent Verbosity</label>
                            <select class="agent-select" id="agentVerbosity">
                                <option value="silent">Silent</option>
                                <option value="results">Results Only</option>
                                <option value="steps" selected>Step-by-Step</option>
                                <option value="reasoning">Show Reasoning</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-title">Output Settings</div>
                    <div class="output-grid">
                        <div class="output-field"><label>Output Directory</label><input type="text" id="outputDir" value="./evaluations/results"></div>
                        <div class="output-field"><label>Report Formats</label><div class="format-btns"><button class="format-btn active" onclick="toggleFormat(this)">JSON</button><button class="format-btn active" onclick="toggleFormat(this)">Markdown</button><button class="format-btn" onclick="toggleFormat(this)">HTML</button><button class="format-btn" onclick="toggleFormat(this)">CSV</button></div></div>
                        <div class="output-field"><label>Save Raw Responses</label><select class="agent-select" id="saveRaw"><option value="none">None</option><option value="failed">Failed Only</option><option value="all" selected>All Responses</option></select></div>
                    </div>
                </div>
            </section>

            <!-- RUN -->
            <section id="run-section" class="content-section">
                <div class="run-layout">
                    <div class="selected-list">
                        <h3>Selected Items</h3>
                        <div id="selectedItemsList"></div>
                    </div>
                    <div class="run-details">
                        <div class="config-summary">
                            <h3>Configuration</h3>
                            <div class="config-row"><span class="config-label">Workflow</span><span class="config-value" id="sumWorkflow">Full-Stack Generation</span></div>
                            <div class="config-row"><span class="config-label">Agent Models</span><span class="config-value" id="sumModels">GPT-4, Claude 3 Opus</span></div>
                            <div class="config-row"><span class="config-label">Pass Threshold</span><span class="config-value" id="sumThresh">70%</span></div>
                            <div class="config-row"><span class="config-label">Scoring Weights</span><span class="config-value">Correctness (31%), Quality (25%), ...</span></div>
                            <div class="config-row"><span class="config-label">Log Level</span><span class="config-value" id="sumLogLevel">Info (Standard)</span></div>
                            <div class="config-row"><span class="config-label">Response Detail</span><span class="config-value" id="sumVerbosity">Summary</span></div>
                            <div class="config-row"><span class="config-label">Output Path</span><span class="config-value" id="sumOutput">./evaluations/results</span></div>
                        </div>
                        <div class="metrics-row">
                            <div class="metric-card"><div class="metric-icon">‚è±Ô∏è</div><div class="metric-label">Estimated Time</div><div class="metric-value" id="estTime">~15 min</div></div>
                            <div class="metric-card"><div class="metric-icon">üí∞</div><div class="metric-label">Estimated Cost</div><div class="metric-value" id="estCost">~$0.50</div></div>
                        </div>
                        <div class="config-section" style="margin-top: 16px;">
                            <div class="config-title">Quick Settings</div>
                            <div class="output-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="output-field">
                                    <label>Output Directory</label>
                                    <input type="text" id="outputDirQuick" value="./evaluations/results" oninput="syncOutputDir(this.value)">
                                </div>
                                <div class="output-field">
                                    <label>Log Level</label>
                                    <select class="agent-select" id="logLevelQuick" onchange="syncLogLevel(this.value)">
                                        <option value="ERROR">Error Only</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="INFO">Info (Standard)</option>
                                        <option value="DEBUG">Debug (Verbose)</option>
                                        <option value="TRACE">Trace (All)</option>
                                    </select>
                                </div>
                                <div class="output-field">
                                    <label>Response Detail</label>
                                    <select class="agent-select" id="responseDetailQuick" onchange="syncResponseDetail(this.value)">
                                        <option value="minimal">Minimal (Pass/Fail)</option>
                                        <option value="summary">Summary</option>
                                        <option value="detailed">Detailed</option>
                                        <option value="full">Full (Raw Output)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="run-actions">
                            <button class="btn btn-large btn-green" id="startRunBtn" onclick="startRun()">‚ñ∂ Start Workflow Run</button>
                            <button class="btn btn-large btn-secondary" onclick="exportConfig()">Export Config</button>
                        </div>
                        <div class="config-section" style="margin-top: 16px;">
                            <div class="config-title">Run Status</div>
                            <div style="display:flex; justify-content: space-between; gap: 12px; align-items: center;">
                                <div id="runStatusText" style="color: var(--text-secondary); font-size: 13px;">Idle</div>
                                <div id="runStatusMeta" style="color: var(--text-muted); font-size: 12px;"></div>
                            </div>
                            <div style="margin-top: 10px;">
                                <div style="display:flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                                    <span>Progress</span>
                                    <span id="runProgressText">0%</span>
                                </div>
                                <div class="dash-progress-bar" style="margin-top: 6px;">
                                    <div class="dash-progress-fill" id="runProgressFill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="runResults" style="margin-top: 12px;"></div>
                            <div style="margin-top: 12px;">
                                <div class="config-title" style="margin-bottom: 8px;">Output Watch</div>
                                <textarea id="watchCmd" class="dash-output" readonly style="width:100%; height:90px;"></textarea>
                                <div style="display:flex; gap: 8px; margin-top: 8px;">
                                    <button class="btn btn-secondary" onclick="copyWatchCmd()">Copy watch cmd</button>
                                    <button class="btn btn-secondary" onclick="copyRunIds()">Copy run id(s)</button>
                                </div>
                                <div style="margin-top: 6px; font-size: 12px; color: var(--text-muted);">
                                    Output files are saved as <code>run_&lt;id&gt;.json</code> under the output directory.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- LIVE DASHBOARD -->
            <section id="dashboard-section" class="content-section">
                <!-- View Toggle -->
                <div class="dash-view-toggle">
                    <button class="dash-view-btn active" data-view="grid" onclick="setDashView('grid')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        All Workflows
                    </button>
                    <button class="dash-view-btn" data-view="detail" onclick="setDashView('detail')" id="detailViewBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg>
                        <span id="detailViewLabel">Workflow Details</span>
                    </button>
                    <div class="dash-live-badge">
                        <div class="live-pulse"></div>
                        <span>Live ‚Ä¢ Auto-refresh 2s</span>
                    </div>
                </div>
                
                <!-- GRID VIEW: All Workflows -->
                <div class="dash-grid-view" id="dashGridView">
                    <div class="dash-section-header">
                        <h3>üîÑ Running Workflows</h3>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="refreshDashboard()">‚Üª Refresh</button>
                    </div>
                    <div class="dash-workflow-grid" id="dashRunningGrid">
                        <div class="dash-empty">No running workflows. Start one from the Run Workflow tab.</div>
                    </div>
                    
                    <div class="dash-section-header" style="margin-top: 24px;">
                        <h3>‚úÖ Completed Workflows</h3>
                        <span class="dash-count" id="completedCount">0</span>
                    </div>
                    <div class="dash-workflow-grid" id="dashCompletedGrid">
                        <div class="dash-empty">No completed workflows yet.</div>
                    </div>
                </div>
                
                <!-- DETAIL VIEW: Single Workflow Drill-down -->
                <div class="dash-detail-view" id="dashDetailView" style="display: none;">
                    <button class="dash-back-btn" onclick="setDashView('grid')">‚Üê Back to All Workflows</button>
                    
                    <div class="dashboard-layout">
                        <!-- Run History Sidebar -->
                        <div class="dash-sidebar">
                            <div class="dash-sidebar-header">
                                <h3>üìã Run History</h3>
                            </div>
                            <div class="dash-run-list" id="dashRunList">
                                <div class="dash-empty">No runs yet.</div>
                            </div>
                        </div>
                        
                        <!-- Main Pipeline View -->
                        <div class="dash-main">
                            <div class="dash-run-header" id="dashRunHeader">
                                <div class="dash-run-info">
                                    <h2 id="dashWorkflowName">Select a Run</h2>
                                    <div class="dash-meta">
                                        <span id="dashStartTime">--</span>
                                        <span id="dashDuration">--</span>
                                        <span class="dash-status-badge" id="dashStatus">--</span>
                                    </div>
                                </div>
                                <div class="dash-live-indicator">
                                    <div class="live-pulse"></div>
                                    <span>Live Updates</span>
                                </div>
                            </div>
                            
                            <div class="dash-pipeline" id="dashPipeline">
                                <div class="dash-empty">Select a run from the sidebar to view the pipeline</div>
                            </div>
                        </div>
                        
                        <!-- Step Detail Panel -->
                        <div class="dash-detail" id="dashDetail">
                            <div class="dash-detail-header">
                                <h3 id="dashStepName">Step Details</h3>
                                <span class="dash-agent-name" id="dashAgentName">--</span>
                            </div>
                            <div class="dash-tabs">
                                <button class="dash-tab active" data-tab="output" onclick="setDashTab('output')">Output</button>
                                <button class="dash-tab" data-tab="input" onclick="setDashTab('input')">Input</button>
                                <button class="dash-tab" data-tab="stats" onclick="setDashTab('stats')">Stats</button>
                            </div>
                            <div class="dash-content" id="dashContent">
                                <div class="dash-empty">Click a step to view details</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AGENTS ROSTER -->
            <section id="agents-section" class="content-section">
                <div class="agents-header">
                    <div class="agents-title-row">
                        <h2>ü§ñ Agent Roster</h2>
                        <div class="agents-actions">
                            <button class="btn btn-secondary" onclick="probeModels()" id="probeBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                                Probe Available Models
                            </button>
                            <button class="btn btn-primary" onclick="saveAgentConfig()">üíæ Save Configuration</button>
                        </div>
                    </div>
                    <p class="agents-subtitle">Configure model assignments for each agent in your workflows</p>
                </div>
                
                <!-- Available Models -->
                <div class="config-section" style="margin-bottom: 24px;">
                    <div class="config-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üì° Available Models</span>
                        <span class="model-count" id="modelCount">0 models</span>
                    </div>
                    <div class="model-chips" id="modelChips">
                        <span class="model-chip loading">Probing models...</span>
                    </div>
                </div>
                
                <!-- Agent Grid -->
                <div class="agent-grid" id="agentGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </section>
        </main>
    </div>

<script>
// Production-level dataset definitions with full benchmark data
const humanEvalTasks = [
    'has_close_elements', 'separate_paren_groups', 'truncate_number', 'below_zero', 'mean_absolute_deviation',
    'intersperse', 'parse_nested_parens', 'filter_by_substring', 'sum_product', 'rolling_max',
    'make_palindrome', 'string_xor', 'longest', 'greatest_common_divisor', 'all_prefixes',
    'string_sequence', 'count_distinct_characters', 'parse_music', 'how_many_times', 'sort_numbers',
    'find_closest_elements', 'rescale_to_unit', 'filter_integers', 'strlen', 'largest_divisor',
    'factorize', 'remove_duplicates', 'flip_case', 'concatenate', 'filter_by_prefix',
    'get_positive', 'is_prime', 'find_zero', 'sort_third', 'unique', 'max_element',
    'fizz_buzz', 'encode_shift', 'decode_shift', 'remove_vowels', 'below_threshold',
    'add', 'same_chars', 'fib', 'correct_bracketing', 'monotonic', 'common',
    'largest_prime_factor', 'sum_to_n', 'brackets_balanced', 'derivative', 'fibfib',
    'vowels_count', 'circular_shift', 'digitSum', 'fruit_distribution', 'pluck',
    'search', 'strange_sort_list', 'triangle_area', 'will_it_fly', 'smallest_change',
    'total_match', 'is_multiply_prime', 'is_simple_power', 'iscube', 'hex_key',
    'decimal_to_binary', 'is_happy', 'numerical_letter_grade', 'prime_length', 'starts_one_ends',
    'solve', 'add_elements', 'get_odd_collatz', 'valid_date', 'split_words',
    'is_sorted', 'intersection', 'prod_signs', 'minPath', 'tri', 'digits',
    'is_nested', 'sum_squares', 'check_if_last_char_is_letter', 'can_arrange', 'largest_smallest_integers',
    'compare_one', 'is_equal_to_sum_even', 'special_factorial', 'fix_spaces', 'file_name_check',
    'sum_squares_2', 'words_in_sentence', 'simplify', 'order_by_points', 'count_nums',
    'move_one_ball', 'exchange', 'histogram', 'reverse_delete', 'odd_count',
    'minSubArraySum', 'max_fill', 'sort_array', 'select_words', 'get_closest_vowel',
    'match_parens', 'maximum', 'solution', 'add_elements_2', 'get_max_triples',
    'bf', 'sorted_list_sum', 'x_or_y', 'double_the_difference', 'compare',
    'Strongest_Extension', 'cycpattern_check', 'even_odd_count', 'count_upper', 'closest_integer',
    'make_a_pile', 'words_string', 'choose_num', 'rounded_avg', 'unique_digits',
    'by_length', 'f', 'even_odd_palindrome', 'count_nums_2', 'move_one_ball_2',
    'split_words_2', 'is_sorted_2', 'encrypt', 'next_smallest', 'is_bored',
    'any_int', 'encode', 'skjkasdkd', 'check_dict_case', 'count_up_to',
    'multiply', 'count_upper_2', 'closest_integer_2', 'make_a_pile_2', 'words_string_2',
    'choose_num_2', 'rounded_avg_2', 'unique_digits_2', 'by_length_2', 'even_odd_palindrome_2'
];

const mbppTasks = [
    'find_max', 'factorial', 'fibonacci', 'is_palindrome', 'count_vowels', 'reverse_string', 'sum_list', 'find_min',
    'is_prime', 'gcd', 'lcm', 'binary_search', 'bubble_sort', 'insertion_sort', 'merge_sort', 'quick_sort',
    'linear_search', 'count_words', 'remove_duplicates', 'flatten_list', 'transpose_matrix', 'matrix_multiply',
    'power', 'sqrt_newton', 'is_armstrong', 'digit_sum', 'count_digits', 'is_perfect', 'sum_of_divisors',
    'prime_factors', 'nth_prime', 'sieve_of_eratosthenes', 'is_leap_year', 'days_in_month', 'day_of_week',
    'roman_to_int', 'int_to_roman', 'is_anagram', 'longest_substring', 'valid_parentheses', 'generate_parentheses',
    'merge_intervals', 'insert_interval', 'two_sum', 'three_sum', 'four_sum', 'container_with_most_water',
    'trapping_rain_water', 'longest_common_subsequence', 'edit_distance', 'coin_change', 'knapsack_01',
    'climbing_stairs', 'house_robber', 'decode_ways', 'word_break', 'longest_increasing_subsequence',
    'maximum_subarray', 'product_except_self', 'find_duplicate', 'missing_number', 'single_number',
    'majority_element', 'rotate_array', 'move_zeroes', 'contains_duplicate', 'intersection_arrays',
    'plus_one', 'sqrt_int', 'valid_perfect_square', 'happy_number', 'ugly_number', 'count_primes',
    'power_of_two', 'power_of_three', 'power_of_four', 'add_digits', 'is_ugly', 'nth_ugly_number',
    'missing_ranges', 'summary_ranges', 'minimum_size_subarray', 'kth_largest', 'merge_k_sorted',
    'reverse_linked_list', 'detect_cycle', 'merge_two_sorted', 'remove_nth_from_end', 'swap_pairs',
    'rotate_list', 'partition_list', 'reverse_between', 'copy_random_list', 'word_ladder',
    'surrounded_regions', 'palindrome_partitioning', 'clone_graph', 'gas_station', 'candy',
    'single_number_ii', 'single_number_iii', 'word_break_ii', 'linked_list_cycle_ii', 'reorder_list',
    'insertion_sort_list', 'sort_list', 'max_points_on_line', 'evaluate_rpn', 'reverse_words',
    'max_product_subarray', 'find_minimum_rotated', 'find_peak_element', 'compare_version', 'fraction_to_decimal'
];

const sweRepos = ['django/django', 'flask/flask', 'requests/requests', 'pandas-dev/pandas', 'scikit-learn/scikit-learn', 
    'pytorch/pytorch', 'tensorflow/tensorflow', 'numpy/numpy', 'matplotlib/matplotlib', 'sympy/sympy'];
const sweIssueTypes = [
    'Fix regression in', 'Resolve memory leak in', 'Address performance issue in', 'Fix incorrect behavior in',
    'Handle edge case in', 'Fix type error in', 'Resolve deprecation warning in', 'Fix documentation for',
    'Add missing validation in', 'Fix security vulnerability in', 'Resolve race condition in', 'Fix serialization bug in'
];
const sweComponents = ['QuerySet', 'ORM', 'Template Engine', 'Form Validation', 'URL Routing', 'Middleware', 
    'Cache Backend', 'Admin Interface', 'Auth System', 'Migration System', 'Signal Handler', 'Database Connection'];

const datasetDefinitions = {
    humaneval: {
        source: 'HumanEval',
        icon: 'üêç',
        items: humanEvalTasks.map((task, i) => ({
            id: `HE${i}`,
            name: `HumanEval/${i}`,
            source: 'HumanEval',
            desc: `Implement ${task.replace(/_/g, ' ')}`,
            difficulty: ['Easy', 'Easy', 'Medium', 'Medium', 'Hard'][i % 5],
            category: 'Python',
            signature: `def ${task}(...):`,
            testCase: `assert ${task}(...) == expected`,
            constraints: ['Handle edge cases', 'O(n) time complexity', 'No external libraries', 'Type hints required'][i % 4]
        }))
    },
    mbpp: {
        source: 'MBPP',
        icon: 'üìò',
        items: mbppTasks.map((task, i) => ({
            id: `MB${i+1}`,
            name: `MBPP/${i+1}`,
            source: 'MBPP',
            desc: `Write a function for ${task.replace(/_/g, ' ')}`,
            difficulty: ['Easy', 'Easy', 'Medium', 'Medium', 'Hard'][i % 5],
            category: 'Python',
            signature: `def ${task}(...):`,
            testCase: `assert ${task}(...) == expected`,
            constraints: ['Include docstring', 'Handle empty input', 'Return type specified', 'Unit tests pass'][i % 4]
        }))
    },
    swebench: {
        source: 'SWE-bench',
        icon: 'üîß',
        items: Array.from({length: 300}, (_, i) => {
            const repo = sweRepos[i % sweRepos.length];
            const issueType = sweIssueTypes[i % sweIssueTypes.length];
            const component = sweComponents[i % sweComponents.length];
            return {
                id: `SW${i+1}`,
                name: `${repo.split('/')[0]}/${repo.split('/')[1]}#${10000+i}`,
                source: 'SWE-bench',
                desc: `${issueType} ${component}`,
                difficulty: ['Medium', 'Hard', 'Hard', 'Hard', 'Medium'][i % 5],
                category: repo.split('/')[1].charAt(0).toUpperCase() + repo.split('/')[1].slice(1),
                repo: repo,
                issueUrl: `https://github.com/${repo}/issues/${10000+i}`,
                patchSize: [`${(i % 15) + 1} files`, `${(i % 8) + 1} files`, `${(i % 20) + 3} files`][i % 3],
                constraints: ['Must pass CI', 'Backward compatible', 'No new dependencies', 'Documentation update'][i % 4]
            };
        })
    },
    custom: {
        source: 'Custom',
        icon: 'üìÅ',
        items: Array.from({length: 50}, (_, i) => ({
            id: `CU${i+1}`,
            name: `Custom/${i+1}`,
            source: 'Custom',
            desc: ['API integration test', 'Legacy migration', 'Performance optimization', 'Security audit', 'Code review'][i % 5],
            difficulty: ['Easy', 'Medium', 'Hard', 'Medium', 'Easy'][i % 5],
            category: ['Backend', 'Frontend', 'DevOps', 'Security', 'QA'][i % 5],
            owner: ['Team Alpha', 'Platform', 'DevOps', 'Security', 'QA'][i % 5],
            constraints: ['Custom validation', 'VPN access', 'GPU required', 'Staging env', 'Manual review'][i % 5]
        }))
    }
};

// Flatten all datasets - will be populated by loadDatasets()
let datasets = [];

let apiOnline = false;

function _escapeHtml(s) {
    return String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// Populated from the local API server's model probe (/api/models).
// Always keep a baseline option so the UI remains usable even without API access.
let availableModels = [
    { id: '', label: '(Gold baseline ‚Äî no model call)', selectable: true }
];

async function loadModels() {
    if (!apiOnline) return;
    try {
        const resp = await fetch('/api/models', { cache: 'no-store' });
        if (!resp.ok) return;
        const data = await resp.json();
        const models = Array.isArray(data.models) ? data.models : [];
        const selectable = models.filter(m => m && m.selectable && m.id);

        // Sort for a nicer dropdown (local first, then everything else).
        selectable.sort((a, b) => {
            const ap = String(a.id || '').startsWith('local:') ? 0 : 1;
            const bp = String(b.id || '').startsWith('local:') ? 0 : 1;
            if (ap !== bp) return ap - bp;
            return String(a.id).localeCompare(String(b.id));
        });

        availableModels = [
            { id: '', label: '(Gold baseline ‚Äî no model call)', selectable: true },
            ...selectable.map(m => ({ id: String(m.id), label: String(m.id), selectable: true }))
        ];

        // Re-render pipeline to update dropdowns.
        updatePipeline();
        updateRunSection();
    } catch (_) {
        // Leave fallback model list.
    }
}

function copyServerCommand() {
    // Browsers can't start a local Python process. This copies a command that works
    // even when the package isn't installed (by setting PYTHONPATH to ./src).
    const cmd = [
        'Push-Location .\\multiagent-workflows',
        '$env:PYTHONPATH = "$PWD\\src"',
        '& "..\\.venv\\Scripts\\python.exe" -m multiagent_workflows.server --port 8010',
        'Pop-Location'
    ].join('\n');
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(cmd).then(() => {
            const el = document.getElementById('apiText');
            const old = el.textContent;
            el.textContent = 'Copied start cmd';
            setTimeout(() => el.textContent = old, 1200);
        }).catch(() => alert(cmd));
    } else {
        alert(cmd);
    }
}

function _setApiStatus(isOnline, detail) {
    apiOnline = !!isOnline;
    const dot = document.getElementById('apiDot');
    const text = document.getElementById('apiText');
    dot.classList.remove('ok', 'bad');
    dot.classList.add(apiOnline ? 'ok' : 'bad');
    text.textContent = apiOnline ? 'API: online' : ('API: offline' + (detail ? ` (${detail})` : ''));
}

async function checkApiNow(shouldReload) {
    try {
        const r = await fetch('/api/health', { cache: 'no-store' });
        if (r.ok) {
            const data = await r.json();
            _setApiStatus(!!data.ok);
            if (shouldReload) {
                await loadDatasets();
                await loadModels();
            }
            return;
        }
        _setApiStatus(false, String(r.status));
    } catch (_) {
        _setApiStatus(false, 'not running');
    }
}

// Load datasets from JSON files
async function loadDatasets() {
    const sources = [
        // Prefer online datasets via the local API server.
        { api: '/api/tasks?benchmark_id=humaneval&limit=200', file: 'data/humaneval.json', source: 'HumanEval', icon: 'üêç' },
        { api: '/api/tasks?benchmark_id=mbpp&limit=300', file: 'data/mbpp.json', source: 'MBPP', icon: 'üìò' },
        { api: '/api/tasks?benchmark_id=swe-bench-lite&limit=300', file: 'data/swebench.json', source: 'SWE-bench', icon: 'üîß' }
    ];

    const allTasks = [];

    for (const src of sources) {
        try {
            // Try API first (same-origin when served via the included Python server).
            let response = null;
            try {
                response = await fetch(src.api);
            } catch (_) {
                response = null;
            }

            // Fallback to local bundled JSON.
            if (!response || !response.ok) {
                response = await fetch(src.file);
            }

            if (response.ok) {
                const data = await response.json();
                const rawTasks = data.tasks || [];
                const tasks = rawTasks.map((task, i) => {
                    // Handle variable test case formats
                    let testContent = task.test || task.testCase;
                    if (!testContent && task.test_list) {
                        testContent = Array.isArray(task.test_list) ? task.test_list.join('\n') : task.test_list;
                    }
                    if (!testContent && task.test_patch) {
                        testContent = task.test_patch;
                    }

                    // Handle variable difficulty
                    let difficulty = task.difficulty;
                    if (!difficulty && src.source === 'MBPP') difficulty = 'Easy';
                    if (!difficulty) difficulty = 'Medium';

                    return {
                        id: task.task_id || task.instance_id || `${src.source.substring(0,2).toUpperCase()}${i}`,
                        name: task.task_id || task.instance_id || `${src.source}/${i}`,
                        source: src.source,
                        desc: task.prompt || task.problem_statement || task.name || task.description,
                        difficulty: difficulty,
                        category: task.repo ? task.repo.split('/')[1] : (task.language || 'Python'),
                        signature: task.entry_point ? `def ${task.entry_point}(...):` : undefined,
                        testCase: testContent ? (testContent.length > 300 ? testContent.substring(0, 300) + '...' : testContent) : undefined,
                        constraints: task.canonical_solution ? 'Reference solution available' : 'No reference',
                        repo: task.repo,
                        issueUrl: (task.repo && (task.instance_id || task.task_id)) ? `https://github.com/${task.repo}/issues/${String(task.instance_id || task.task_id).split('-').pop()}` : undefined,
                        patchSize: task.patch ? `${task.patch.split('\n').length} lines` : undefined
                    };
                });
                allTasks.push(...tasks);
                console.log(`‚úì Loaded ${tasks.length} tasks from ${src.source}`);
            }
        } catch (e) {
            console.warn(`Could not load ${src.file}:`, e.message);
        }
    }
    
    // Add custom tasks
    const customTasks = Array.from({length: 50}, (_, i) => ({
        id: `CU${i+1}`,
        name: `Custom/${i+1}`,
        source: 'Custom',
        desc: ['API integration test', 'Legacy migration', 'Performance optimization', 'Security audit', 'Code review'][i % 5],
        difficulty: ['Easy', 'Medium', 'Hard', 'Medium', 'Easy'][i % 5],
        category: ['Backend', 'Frontend', 'DevOps', 'Security', 'QA'][i % 5],
        owner: ['Team Alpha', 'Platform', 'DevOps', 'Security', 'QA'][i % 5],
        constraints: ['Custom validation', 'VPN access', 'GPU required', 'Staging env', 'Manual review'][i % 5]
    }));
    allTasks.push(...customTasks);
    
    // If no external data loaded, use fallback static data
    if (allTasks.length <= 50) {
        console.log('Using fallback static data...');
        allTasks.push(...generateFallbackData());
    }
    
    datasets = allTasks;
    console.log(`Total datasets loaded: ${datasets.length}`);
    render();
}

// Fallback static data generator
function generateFallbackData() {
    const fallbackData = [];
    
    // HumanEval fallback
    const heTasks = ['has_close_elements', 'separate_paren_groups', 'truncate_number', 'below_zero', 
        'mean_absolute_deviation', 'intersperse', 'parse_nested_parens', 'filter_by_substring'];
    heTasks.forEach((task, i) => {
        for (let j = 0; j < 20; j++) {
            fallbackData.push({
                id: `HE${i*20+j}`, name: `HumanEval/${i*20+j}`, source: 'HumanEval',
                desc: `Implement ${task.replace(/_/g, ' ')}`, difficulty: ['Easy', 'Medium', 'Hard'][j % 3],
                category: 'Python', signature: `def ${task}(...):`, constraints: 'Handle edge cases'
            });
        }
    });
    
    // MBPP fallback
    const mbTasks = ['find_max', 'factorial', 'fibonacci', 'is_palindrome', 'binary_search'];
    mbTasks.forEach((task, i) => {
        for (let j = 0; j < 20; j++) {
            fallbackData.push({
                id: `MB${i*20+j}`, name: `MBPP/${i*20+j+1}`, source: 'MBPP',
                desc: `Write function for ${task.replace(/_/g, ' ')}`, difficulty: ['Easy', 'Medium', 'Hard'][j % 3],
                category: 'Python', signature: `def ${task}(...):`, constraints: 'Include docstring'
            });
        }
    });
    
    // SWE-bench fallback
    const repos = ['django/django', 'flask/flask', 'requests/requests', 'pandas-dev/pandas', 'sympy/sympy'];
    repos.forEach((repo, i) => {
        for (let j = 0; j < 60; j++) {
            fallbackData.push({
                id: `SW${i*60+j}`, name: `${repo}#${10000+j}`, source: 'SWE-bench',
                desc: `Fix issue in ${repo.split('/')[1]}`, difficulty: ['Medium', 'Hard'][j % 2],
                category: repo.split('/')[1], repo: repo, 
                issueUrl: `https://github.com/${repo}/issues/${10000+j}`, patchSize: `${j % 15 + 1} files`
            });
        }
    });
    
    return fallbackData;
}


const scores = [
    {name: 'Correctness', weight: 81, value: 70, checked: true},
    {name: 'Quality', weight: 25, value: 20, checked: true},
    {name: 'Documents', weight: 25, value: 40, checked: true},
    {name: 'Dock', weight: 15, value: 55, checked: true},
    {name: 'PFSence', weight: 0, value: 20, checked: true},
    {name: 'PSfence', weight: 9, value: 38, checked: true}
];

// Workflow definitions with agents and feedback loops
const workflows = {
    fullstack: {
        name: 'Full-Stack Generation',
        agents: [
            {id: 'vision', name: 'Vision Agent', icon: 'üëÅÔ∏è', color: '#3b82f6'},
            {id: 'requirements', name: 'Requirements', icon: 'üìã', color: '#22c55e'},
            {id: 'architect', name: 'Architect', icon: 'üèóÔ∏è', color: '#8b5cf6'},
            {id: 'coder', name: 'Coder', icon: 'üíª', color: '#f59e0b'},
            {id: 'reviewer', name: 'Reviewer', icon: '‚úÖ', color: '#22c55e'},
            {id: 'tester', name: 'Tester', icon: 'üß™', color: '#ec4899'}
        ],
        flow: ['vision', 'requirements', 'architect', 'coder', 'reviewer', 'tester'],
        feedback: [{from: 'reviewer', to: 'coder', label: 'Fix Issues'}]
    },
    refactoring: {
        name: 'Legacy Refactoring',
        agents: [
            {id: 'archaeologist', name: 'Archaeologist', icon: 'üîç', color: '#f59e0b'},
            {id: 'analyst', name: 'Code Analyst', icon: 'üìä', color: '#3b82f6'},
            {id: 'strategist', name: 'Strategist', icon: 'üéØ', color: '#8b5cf6'},
            {id: 'refactorer', name: 'Refactorer', icon: 'üîÑ', color: '#22c55e'},
            {id: 'validator', name: 'Validator', icon: '‚úì', color: '#ec4899'}
        ],
        flow: ['archaeologist', 'analyst', 'strategist', 'refactorer', 'validator'],
        feedback: [{from: 'validator', to: 'refactorer', label: 'Iterate'}]
    },
    bugfix: {
        name: 'Bug Triage & Fix',
        agents: [
            {id: 'triager', name: 'Triager', icon: 'üì•', color: '#ef4444'},
            {id: 'reproducer', name: 'Reproducer', icon: 'üîÅ', color: '#f59e0b'},
            {id: 'rootcause', name: 'Root Cause', icon: 'üî¨', color: '#3b82f6'},
            {id: 'fixer', name: 'Fixer', icon: 'üîß', color: '#22c55e'},
            {id: 'verifier', name: 'Verifier', icon: '‚úÖ', color: '#8b5cf6'}
        ],
        flow: ['triager', 'reproducer', 'rootcause', 'fixer', 'verifier'],
        feedback: [{from: 'verifier', to: 'fixer', label: 'Retry Fix'}, {from: 'reproducer', to: 'triager', label: 'Re-triage'}]
    },
    architecture: {
        name: 'Architecture Evolution',
        agents: [
            {id: 'scanner', name: 'Scanner', icon: 'üì°', color: '#3b82f6'},
            {id: 'assessor', name: 'Debt Assessor', icon: 'üí≥', color: '#ef4444'},
            {id: 'planner', name: 'Planner', icon: 'üìê', color: '#8b5cf6'},
            {id: 'simulator', name: 'Simulator', icon: 'üéÆ', color: '#f59e0b'},
            {id: 'documenter', name: 'Documenter', icon: 'üìù', color: '#22c55e'}
        ],
        flow: ['scanner', 'assessor', 'planner', 'simulator', 'documenter'],
        feedback: [{from: 'simulator', to: 'planner', label: 'Revise Plan'}]
    },
    repo_maintenance: {
        name: 'Repository Maintenance',
        agents: [
            {id: 'explorer', name: 'Explorer', icon: 'üîç', color: '#3b82f6'},
            {id: 'tester', name: 'Tester', icon: 'üß™', color: '#22c55e'},
            {id: 'engineering', name: 'Eng Expert', icon: '‚öôÔ∏è', color: '#8b5cf6'},
            {id: 'documenter', name: 'Documenter', icon: 'üìù', color: '#f59e0b'},
            {id: 'cleanup', name: 'Cleanup', icon: 'üßπ', color: '#ec4899'},
            {id: 'triage', name: 'Lib Triage', icon: 'üìö', color: '#06b6d4'},
            {id: 'lats', name: 'LATS QC', icon: 'üî¨', color: '#14b8a6'}
        ],
        flow: ['explorer', 'tester', 'engineering', 'documenter', 'cleanup', 'triage', 'lats'],
        feedback: [
            {from: 'lats', to: 'triage', label: 'Refine (below 80%)'},
            {from: 'triage', to: 'cleanup', label: 'Re-assess'}
        ],
        phases: ['Discovery', 'Analysis (‚à•)', 'Curation', 'Verification', 'Reporting'],
        patterns: ['LATS', 'CoVe', 'G-Eval', 'ReAct', 'Reflexion']
    }
};

function updatePipeline() {
    const selected = document.querySelector('input[name="workflow"]:checked').value;
    const wf = workflows[selected];
    const container = document.getElementById('pipelineContainer');
    
    let html = '<div class="pipeline-flow">';
    
    // Render agents in flow order
    wf.flow.forEach((agentId, i) => {
        const agent = wf.agents.find(a => a.id === agentId);
        html += `
            <div class="pipeline-agent" data-agent="${agent.id}">
                <div class="agent-header">
                    <div class="agent-icon" style="background:${agent.color}">${agent.icon}</div>
                    <span class="agent-name">${agent.name}</span>
                </div>
                <select class="agent-select" id="model_${agent.id}">
                    ${availableModels.map(m => `<option value="${_escapeHtml(m.id)}">${_escapeHtml(m.label)}</option>`).join('')}
                </select>
            </div>
        `;
        if (i < wf.flow.length - 1) {
            html += '<span class="pipeline-arrow">‚Üí</span>';
        }
    });
    
    html += '</div>';
    
    // Render feedback loops
    if (wf.feedback && wf.feedback.length > 0) {
        html += '<div class="feedback-loops">';
        wf.feedback.forEach(fb => {
            const fromAgent = wf.agents.find(a => a.id === fb.from);
            const toAgent = wf.agents.find(a => a.id === fb.to);
            html += `
                <div class="feedback-loop">
                    <span class="feedback-arrow">‚Ü©</span>
                    <span class="feedback-label">${fb.label}: ${fromAgent.name} ‚Üí ${toAgent.name}</span>
                </div>
            `;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

let state = {selected: new Set(), page: 1, perPage: 8};

function getFilteredData() {
    const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const sourceFilter = document.getElementById('filterSource')?.value || '';
    const difficultyFilter = document.getElementById('filterDifficulty')?.value || '';
    const sortBy = document.getElementById('sortBy')?.value || 'default';
    
    // Filter
    let filtered = datasets.filter(d => {
        const matchesSearch = d.name.toLowerCase().includes(searchTerm) || d.desc.toLowerCase().includes(searchTerm);
        const matchesSource = !sourceFilter || d.source === sourceFilter;
        const matchesDifficulty = !difficultyFilter || d.difficulty === difficultyFilter;
        return matchesSearch && matchesSource && matchesDifficulty;
    });
    
    // Sort
    const difficultyOrder = {'Easy': 1, 'Medium': 2, 'Hard': 3};
    if (sortBy === 'name') {
        filtered.sort((a, b) => a.name.localeCompare(b.name));
    } else if (sortBy === 'name-desc') {
        filtered.sort((a, b) => b.name.localeCompare(a.name));
    } else if (sortBy === 'difficulty') {
        filtered.sort((a, b) => difficultyOrder[a.difficulty] - difficultyOrder[b.difficulty]);
    } else if (sortBy === 'source') {
        filtered.sort((a, b) => a.source.localeCompare(b.source));
    }
    
    return filtered;
}

function render() {
    const filtered = getFilteredData();
    const start = (state.page - 1) * state.perPage;
    const pageData = filtered.slice(start, start + state.perPage);
    
    document.getElementById('totalItems').textContent = filtered.length;
    document.getElementById('showStart').textContent = filtered.length ? start + 1 : 0;
    document.getElementById('showEnd').textContent = Math.min(start + state.perPage, filtered.length);
    
    document.getElementById('datasetContainer').innerHTML = pageData.map(d => {
        const sourceIcons = {'HumanEval': 'üêç', 'MBPP': 'üìò', 'SWE-bench': 'üîß', 'Custom': 'üìÅ'};
        return `
        <div class="dataset-card ${state.selected.has(d.id) ? 'selected' : ''}" onclick="toggleSelect('${d.id}')">
            <div class="card-header">
                <div class="card-title">${d.name}</div>
                <div class="card-icon">${sourceIcons[d.source] || 'üìÑ'}</div>
            </div>
            <div class="card-tags">
                <span class="tag tag-${d.difficulty.toLowerCase()}">${d.difficulty}</span>
                <span class="tag tag-python">${d.category}</span>
            </div>
            <div class="card-desc">${d.desc}</div>
            <button class="view-details-btn" onclick="event.stopPropagation();showDetails('${d.id}')">‚äï View Details</button>
        </div>
    `}).join('');
    
    const totalPages = Math.ceil(filtered.length / state.perPage);
    // Clamp current page to valid range
    if (state.page > totalPages && totalPages > 0) state.page = totalPages;
    if (state.page < 1) state.page = 1;
    
    let paginationHtml = '';
    
    // Previous button
    paginationHtml += `<button class="page-btn" onclick="goPage(${state.page - 1})" ${state.page <= 1 ? 'disabled' : ''}>‚Üê</button>`;
    
    if (totalPages <= 7) {
        // Show all pages if 7 or fewer
        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<button class="page-btn ${i === state.page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
        }
    } else {
        // Always show first page
        paginationHtml += `<button class="page-btn ${1 === state.page ? 'active' : ''}" onclick="goPage(1)">1</button>`;
        
        // Calculate window around current page
        let windowStart = Math.max(2, state.page - 1);
        let windowEnd = Math.min(totalPages - 1, state.page + 1);
        
        // Adjust window to show at least 3 pages in the middle
        if (windowStart <= 2) {
            windowEnd = Math.min(totalPages - 1, 4);
        }
        if (windowEnd >= totalPages - 1) {
            windowStart = Math.max(2, totalPages - 3);
        }
        
        // Left ellipsis
        if (windowStart > 2) {
            paginationHtml += `<button class="page-btn" disabled>‚Ä¶</button>`;
        }
        
        // Window pages
        for (let i = windowStart; i <= windowEnd; i++) {
            paginationHtml += `<button class="page-btn ${i === state.page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
        }
        
        // Right ellipsis
        if (windowEnd < totalPages - 1) {
            paginationHtml += `<button class="page-btn" disabled>‚Ä¶</button>`;
        }
        
        // Always show last page
        paginationHtml += `<button class="page-btn ${totalPages === state.page ? 'active' : ''}" onclick="goPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHtml += `<button class="page-btn" onclick="goPage(${state.page + 1})" ${state.page >= totalPages ? 'disabled' : ''}>‚Üí</button>`;
    
    document.getElementById('pageButtons').innerHTML = paginationHtml;
    
    document.getElementById('selCount').textContent = state.selected.size;
    updateSelectAllToggle();
}

function renderScoring() {
    document.getElementById('scoringOptions').innerHTML = scores.map((s, i) => `
        <div class="score-item">
            <input type="checkbox" class="score-checkbox" ${s.checked ? 'checked' : ''} onchange="scores[${i}].checked=this.checked;updateTotal()">
            <span class="score-label">${s.name} (${s.weight}%)</span>
            <input type="range" class="score-slider" value="${s.value}" min="0" max="100" oninput="scores[${i}].value=this.value;updateTotal();this.nextElementSibling.textContent=this.value+'%'" style="background:linear-gradient(to right, var(--accent) ${s.value}%, var(--bg-tertiary) ${s.value}%)">
            <span class="score-value">${s.value}%</span>
        </div>
    `).join('');
    updateTotal();
}

function updateTotal() {
    const total = scores.filter(s => s.checked).reduce((sum, s) => sum + parseInt(s.value) * s.weight / 100, 0);
    document.getElementById('totalScore').textContent = Math.round(total) + '%';
}

function toggleSelect(id) {
    state.selected.has(id) ? state.selected.delete(id) : state.selected.add(id);
    render();
}

function showDetails(id) {
    const d = datasets.find(ds => ds.id === id);
    if (!d) return;
    
    // Build source-specific content
    let sourceContent = '';
    
    if (d.source === 'HumanEval' || d.source === 'MBPP') {
        sourceContent = `
            <div class="detail-section">
                <div class="detail-section-title">üì• Function Signature</div>
                <div class="example-block">${d.signature || 'def example():'}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">üì§ Test Case</div>
                <div class="example-block">${d.testCase || 'No test case'}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">üìã Constraints</div>
                <div class="example-block">‚Ä¢ ${d.constraints || 'None specified'}</div>
            </div>
        `;
    } else if (d.source === 'SWE-bench') {
        sourceContent = `
            <div class="detail-row">
                <span class="detail-label">Repository</span>
                <span class="detail-value">${d.repo}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Patch Size</span>
                <span class="detail-value">${d.patchSize}</span>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">ÔøΩ Issue Link</div>
                <div class="example-block">${d.issueUrl}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">üìã Requirements</div>
                <div class="example-block">‚Ä¢ ${d.constraints}</div>
            </div>
        `;
    } else if (d.source === 'Custom') {
        sourceContent = `
            <div class="detail-row">
                <span class="detail-label">Owner</span>
                <span class="detail-value">${d.owner}</span>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">ÔøΩ Requirements</div>
                <div class="example-block">‚Ä¢ ${d.constraints}</div>
            </div>
        `;
    }
    
    document.getElementById('modalTitle').textContent = d.name + ' Details';
    document.getElementById('modalBody').innerHTML = `
        <div class="detail-row">
            <span class="detail-label">Source</span>
            <span class="detail-value"><span class="tag tag-python">${d.source}</span></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Task ID</span>
            <span class="detail-value">${d.id}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Difficulty</span>
            <span class="detail-value"><span class="tag tag-${d.difficulty.toLowerCase()}">${d.difficulty}</span></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Category</span>
            <span class="detail-value">${d.category}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Description</span>
            <span class="detail-value">${d.desc}</span>
        </div>
        
        ${sourceContent}
        
        <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="btn btn-primary" onclick="toggleSelect('${d.id}');closeModal()">${state.selected.has(d.id) ? '‚úì Selected' : '+ Add to Selection'}</button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `;
    document.getElementById('detailsModal').classList.add('active');
    document.getElementById('detailsModal').classList.add('active');
}

function closeAgentEditModal() {
    document.getElementById('agentEditModal').classList.remove('active');
}

function closeModal() {
    document.getElementById('detailsModal').classList.remove('active');
}

function toggleSelectAll() {
    const toggle = document.getElementById('selectAllToggle');
    toggle.classList.toggle('active');
    if (toggle.classList.contains('active')) {
        datasets.forEach(d => state.selected.add(d.id));
    } else {
        state.selected.clear();
    }
    render();
}

function updateSelectAllToggle() {
    const toggle = document.getElementById('selectAllToggle');
    if (state.selected.size === datasets.length) toggle.classList.add('active');
    else toggle.classList.remove('active');
}

function clearSelection() { state.selected.clear(); render(); }
function goPage(p) { state.page = p; render(); }
function adjustRuns(d) { const el = document.getElementById('numRuns'); el.value = Math.max(1, Math.min(10, parseInt(el.value) + d)); }
function toggleFormat(btn) { btn.classList.toggle('active'); }
function msgDuration(s) { if (!s) return ''; return s < 1 ? Math.round(s*1000)+'ms' : s.toFixed(2)+'s'; }


function updateRunSection() {
    const items = Array.from(state.selected).map(id => datasets.find(d => d.id === id)).filter(Boolean);
    document.getElementById('selectedItemsList').innerHTML = items.map(d => `
        <div class="selected-item">
            <div class="item-name">${d.name}</div>
            <div class="item-tags"><span class="tag tag-${d.difficulty.toLowerCase()}">${d.difficulty}</span><span class="tag tag-python">${d.category}</span></div>
            <div class="item-tooltip">
                <div class="tooltip-title">${d.name} Details</div>
                <div class="tooltip-desc">Task: ${d.desc}<br><br>Tags: ${d.difficulty}, ${d.category}, String Manipulation</div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('sumThresh').textContent = document.getElementById('threshold').value + '%';
    document.getElementById('sumOutput').textContent = document.getElementById('outputDir').value;
    document.getElementById('sumLogLevel').textContent = document.getElementById('logLevel').options[document.getElementById('logLevel').selectedIndex].text;
    document.getElementById('sumVerbosity').textContent = document.getElementById('responseDetail').options[document.getElementById('responseDetail').selectedIndex].text;
    
    // Update workflow name and agents
    const selectedWf = document.querySelector('input[name="workflow"]:checked').value;
    const wf = workflows[selectedWf];
    document.getElementById('sumWorkflow').textContent = wf.name;
    const picked = _pickModelForRun();
    document.getElementById('sumModels').textContent = picked ? picked : '(Gold baseline)';
    
    const time = items.length * wf.agents.length * parseInt(document.getElementById('numRuns').value);
    const cost = (items.length * 0.05 * wf.agents.length * parseInt(document.getElementById('numRuns').value)).toFixed(2);
    document.getElementById('estTime').textContent = `~${time} min`;
    document.getElementById('estCost').textContent = `~$${cost}`;

    syncQuickSettingsFromConfig();
    updateWatchCommands();
}

function syncOutputDir(value) {
    const base = document.getElementById('outputDir');
    if (base) base.value = value;
    updateRunSection();
}

function syncLogLevel(value) {
    const base = document.getElementById('logLevel');
    if (base) base.value = value;
    updateRunSection();
}

function syncResponseDetail(value) {
    const base = document.getElementById('responseDetail');
    if (base) base.value = value;
    updateRunSection();
}

function syncQuickSettingsFromConfig() {
    const output = document.getElementById('outputDir');
    const quickOutput = document.getElementById('outputDirQuick');
    if (output && quickOutput) quickOutput.value = output.value;

    const log = document.getElementById('logLevel');
    const quickLog = document.getElementById('logLevelQuick');
    if (log && quickLog) quickLog.value = log.value;

    const resp = document.getElementById('responseDetail');
    const quickResp = document.getElementById('responseDetailQuick');
    if (resp && quickResp) quickResp.value = resp.value;
}

function _benchmarkIdForSource(source) {
    if (source === 'HumanEval') return 'humaneval';
    if (source === 'MBPP') return 'mbpp';
    if (source === 'SWE-bench') return 'swe-bench-lite';
    return null;
}

function _pickModelForRun() {
    // Take a reasonable default from the pipeline dropdowns.
    // Prefer the coder model if available.
    const coder = document.getElementById('model_coder');
    if (coder && coder.value) return coder.value;
    const first = document.querySelector('select[id^="model_"]');
    return first ? first.value : null;
}

function _renderRunResults(runs) {
    const container = document.getElementById('runResults');
    const blocks = [];

    runs.forEach(r => {
        const pct = r.total ? Math.round((r.completed / r.total) * 100) : 0;
        const stepStats = _stepStats(r.items || []);
        const stepText = stepStats.total ? ` ‚Ä¢ steps ${stepStats.done}/${stepStats.total}` : '';
        const header = `<div style="display:flex; justify-content: space-between; align-items:center; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <div style="font-weight:600;">${r.benchmark_id}</div>
            <div style="display:flex; gap: 8px; align-items:center;">
                <div style="color: var(--text-muted); font-size: 12px;">${r.status} ‚Ä¢ ${r.completed}/${r.total} ‚Ä¢ ${pct}%${stepText}</div>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="showRunJson('${r.run_id}')">JSON</button>
            </div>
        </div>`;

        const allItems = r.items || [];
        const totalItems = allItems.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / RUN_PAGE_SIZE));
        const currentPage = Math.min(_runItemPage[r.run_id] || 1, totalPages);
        _runItemPage[r.run_id] = currentPage;
        const start = (currentPage - 1) * RUN_PAGE_SIZE;
        const pageItems = allItems.slice(start, start + RUN_PAGE_SIZE);

        const items = pageItems.map((it, idx) => {
            const badgeColor = it.status === 'error' ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)';
            const badgeText = it.status === 'error' ? '#ef4444' : '#22c55e';
            const stepBadge = _itemStepBadge(it);
            
            let scoreBadge = '';
            if (it.evaluation && (it.evaluation.score !== undefined || it.evaluation.correctness !== undefined)) {
                 const s = it.evaluation.score ?? it.evaluation.correctness;
                 const sColor = s >= 70 ? 'var(--green)' : (s >= 40 ? '#f59e0b' : '#ef4444');
                 scoreBadge = `<span style="font-weight:600; font-size:11px; color:${sColor}; margin-right:8px;">${s}%</span>`;
            }

            const globalIdx = start + idx;
            return `<div style="padding: 10px 0; border-bottom: 1px solid var(--border); display:flex; justify-content: space-between; gap: 12px; align-items: center;">
                <div style="min-width: 0;">
                    <div style="font-size: 13px; font-weight: 500;">${it.task_id}</div>
                    <div style="font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 520px;">${(it.before || '').replace(/\s+/g,' ').trim()}</div>
                </div>
                <div style="display:flex; gap: 8px; align-items:center;">
                    ${scoreBadge}
                    ${stepBadge}
                    <span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: ${badgeColor}; color: ${badgeText};">${it.status}</span>
                    <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="showRunItem('${r.run_id}', ${globalIdx})">View</button>
                </div>
            </div>`;
        }).join('');

        const pager = totalPages > 1 ? `
            <div style="display:flex; justify-content: space-between; align-items:center; padding: 8px 0; font-size: 12px; color: var(--text-muted);">
                <div>Showing ${totalItems ? (start + 1) : 0}-${Math.min(start + RUN_PAGE_SIZE, totalItems)} of ${totalItems}</div>
                <div style="display:flex; gap: 6px; align-items:center;">
                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" ${currentPage <= 1 ? 'disabled' : ''} onclick="setRunPage('${r.run_id}', ${currentPage - 1})">Prev</button>
                    <span>${currentPage}/${totalPages}</span>
                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" ${currentPage >= totalPages ? 'disabled' : ''} onclick="setRunPage('${r.run_id}', ${currentPage + 1})">Next</button>
                </div>
            </div>
        ` : '';

        const body = items || '<div style="padding: 8px 0; color: var(--text-muted); font-size: 12px;">No items yet.</div>';
        blocks.push(`<div style="margin-bottom: 12px;">${header}${body}${pager}</div>`);
    });

    container.innerHTML = blocks.join('') || '<div style="color: var(--text-muted); font-size: 13px;">No results yet.</div>';
}

let _activeRuns = []; // [{run_id, benchmark_id, status, ...}]
let _activeRunMap = {}; // run_id -> run object
let _lastRunIds = [];
let _runItemPage = {};
const RUN_PAGE_SIZE = 20;

async function showRunItem(runId, itemIndex) {
    const run = _activeRunMap[runId];
    if (!run) return;
    const it = (run.items || [])[itemIndex];
    if (!it) return;

    document.getElementById('modalTitle').textContent = `${run.benchmark_id} ‚Ä¢ ${it.task_id}`;
    document.getElementById('modalBody').innerHTML = `
        <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value">${it.status}</span></div>
        ${it.error ? `<div class="detail-section"><div class="detail-section-title">Error</div><div class="example-block">${it.error}</div></div>` : ''}
        ${it.evaluation ? `<div class="detail-section"><div class="detail-section-title">üìä Evaluation ${it.evaluation.score !== undefined ? '(' + it.evaluation.score + '%)' : ''}</div><div class="example-block">${it.evaluation.reasoning || JSON.stringify(it.evaluation, null, 2)}</div></div>` : ''}
        <div class="detail-section"><div class="detail-section-title">Code Before / Input</div><div class="example-block">${it.before || ''}</div></div>
        <div class="detail-section"><div class="detail-section-title">Code After / Model Output</div><div class="example-block">${it.after || ''}</div></div>
        <div class="detail-section"><div class="detail-section-title">Gold Standard</div><div class="example-block">${_escapeHtml(it.gold || '')}</div></div>
        
        ${(it.steps && it.steps.length > 0) ? `
            <div class="detail-section"><div class="detail-section-title">Agent Steps (${it.steps.length})</div>
            ${it.steps.map(s => `
                <div style="margin-bottom:12px; border:1px solid var(--border); border-radius:6px; padding:10px; background:var(--bg-secondary);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                        <span style="font-weight:600;">${_escapeHtml(s.name || s.step_id)}</span>
                        <span style="font-size:11px; color:var(--text-muted);">${_escapeHtml(s.status)} ‚Ä¢ ${_escapeHtml(s.model || '')} ‚Ä¢ ${msgDuration(s.duration)}</span>
                    </div>
                    ${s.output ? `<div class="example-block" style="font-size:12px; max-height:200px; overflow-y:auto;">${_escapeHtml(s.output)}</div>` : ''}
                    ${s.error ? `<div style="color:var(--red); font-size:12px;">Error: ${_escapeHtml(s.error)}</div>` : ''}
                </div>
            `).join('')}
            </div>
        ` : ''}

        <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `;
    document.getElementById('detailsModal').classList.add('active');
}

function setRunPage(runId, page) {
    _runItemPage[runId] = Math.max(1, page);
    if (_activeRuns && _activeRuns.length) {
        _renderRunResults(_activeRuns);
    }
}

function updateWatchCommands() {
    const outputDir = document.getElementById('outputDir')?.value || './evaluations/results';
    const normalized = outputDir.replace(/\//g, '\\');
    const runs = _lastRunIds || [];
    const cmds = runs.length
        ? runs.map(rid => `Get-Content -Path \"${normalized}\\run_${rid}.json\" -Wait`).join('\n')
        : 'Get-Content -Path "./evaluations/results/run_<id>.json" -Wait';
    const el = document.getElementById('watchCmd');
    if (el) el.value = cmds;
}

function copyWatchCmd() {
    const el = document.getElementById('watchCmd');
    if (!el) return;
    const text = el.value || '';
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => alert(text));
    } else {
        alert(text);
    }
}

function copyRunIds() {
    const text = (_lastRunIds || []).join(', ');
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => alert(text));
    } else {
        alert(text);
    }
}

function _stepStats(items) {
    let total = 0;
    let done = 0;
    (items || []).forEach(it => {
        const steps = it.steps || [];
        total += steps.length;
        steps.forEach(s => {
            const status = String(s.status || '').toLowerCase();
            if (status === 'complete' || status === 'completed' || status === 'error' || status === 'failed') {
                done += 1;
            }
        });
    });
    return { total, done };
}

function _itemStepBadge(it) {
    const steps = it.steps || [];
    if (!steps.length) return '';
    const done = steps.filter(s => {
        const status = String(s.status || '').toLowerCase();
        return status === 'complete' || status === 'completed' || status === 'error' || status === 'failed';
    }).length;
    return `<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(59,130,246,0.2); color: var(--blue);">steps ${done}/${steps.length}</span>`;
}

function showRunJson(runId) {
    const run = _activeRunMap[runId];
    if (!run) return;
    const jsonText = JSON.stringify(run, null, 2);
    window._jsonClipboard = jsonText;
    document.getElementById('modalTitle').textContent = `Run JSON ‚Ä¢ ${runId}`;
    document.getElementById('modalBody').innerHTML = `
        <div class="detail-row"><span class="detail-label">Run ID</span><span class="detail-value">${runId}</span></div>
        <div class="detail-row"><span class="detail-label">Benchmark</span><span class="detail-value">${run.benchmark_id || ''}</span></div>
        <div class="detail-section"><div class="detail-section-title">JSON</div><div class="example-block">${_escapeHtml(jsonText)}</div></div>
        <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="copyJsonClipboard()">Copy JSON</button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `;
    document.getElementById('detailsModal').classList.add('active');
}

function copyJsonClipboard() {
    const text = window._jsonClipboard || '';
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => alert(text));
    } else {
        alert(text);
    }
}

async function startRun() {
    if (state.selected.size === 0) {
        alert('Select at least one dataset item first.');
        return;
    }

    // Starting runs requires the local API server. If the user opened index.html directly (file://),
    // we can't start Python from the browser, so provide a clear path.
    if (!apiOnline) {
        await checkApiNow(false);
        if (!apiOnline) {
            alert('The local API server is not running.\n\nUse the "Copy start cmd" button in the header to copy a working PowerShell snippet, then open the URL (default: http://127.0.0.1:8010/).\n\nOnce running, this UI will auto-detect it and start pulling live records + model list.');
            return;
        }
    }

    const btn = document.getElementById('startRunBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    document.getElementById('runStatusText').textContent = 'Starting run(s)...';
    document.getElementById('runStatusMeta').textContent = '';
    document.getElementById('runResults').innerHTML = '';
    document.getElementById('runProgressText').textContent = '0%';
    document.getElementById('runProgressFill').style.width = '0%';

    const selectedWf = document.querySelector('input[name="workflow"]:checked').value;
    const model = _pickModelForRun();

    // Group selections by dataset source
    const selectedItems = Array.from(state.selected)
        .map(id => datasets.find(d => d.id === id))
        .filter(Boolean);

    const groups = {};
    selectedItems.forEach(it => {
        const bid = _benchmarkIdForSource(it.source);
        if (!bid) return;
        if (!groups[bid]) groups[bid] = [];
        groups[bid].push(it.id);
    });

    const runIds = [];
    try {
        for (const [benchmark_id, task_ids] of Object.entries(groups)) {
            const resp = await fetch('/api/runs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({benchmark_id, task_ids, workflow: selectedWf, model: model || null, use_cache: true})
            });
            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error || 'Failed to create run');
            }
            runIds.push(data.run_id);
        }

        document.getElementById('runStatusText').textContent = `Running ${runIds.length} job(s)...`;
        document.getElementById('runStatusMeta').textContent = runIds.join(', ');
        _lastRunIds = runIds.slice();
        updateWatchCommands();

        // Poll runs until all complete
        _activeRuns = [];
        _activeRunMap = {};

        let done = false;
        while (!done) {
            const runs = [];
            for (const rid of runIds) {
                const rresp = await fetch(`/api/runs/${rid}`);
                const r = await rresp.json();
                if (rresp.ok) {
                    runs.push(r);
                    _activeRunMap[rid] = r;
                }
            }

            _activeRuns = runs;
            _renderRunResults(runs);

            const statuses = runs.map(r => r.status);
            done = statuses.every(s => ['completed', 'completed_with_errors', 'failed', 'cancelled'].includes(s));

            const total = runs.reduce((sum, r) => sum + (r.total || 0), 0);
            const completed = runs.reduce((sum, r) => sum + (r.completed || 0), 0);
            const pct = total ? Math.round((completed / total) * 100) : 0;
            document.getElementById('runStatusText').textContent = done ? 'Done' : `Running... (${completed}/${total})`;
            document.getElementById('runProgressText').textContent = `${pct}%`;
            document.getElementById('runProgressFill').style.width = `${pct}%`;

            if (!done) await new Promise(res => setTimeout(res, 500));
        }

    } catch (e) {
        document.getElementById('runStatusText').textContent = 'Failed to start/run.';
        document.getElementById('runStatusMeta').textContent = e.message || String(e);
        alert(`Run failed: ${e.message || e}`);
    } finally {
        btn.disabled = false;
        btn.textContent = '‚ñ∂ Start Workflow Run';
    }
}
function exportConfig() {
    const config = {
        datasets: Array.from(state.selected), 
        threshold: document.getElementById('threshold').value, 
        runs: document.getElementById('numRuns').value,
        logLevel: document.getElementById('logLevel').value,
        responseDetail: document.getElementById('responseDetail').value,
        agentVerbosity: document.getElementById('agentVerbosity').value,
        saveRawResponses: document.getElementById('saveRaw').value,
        outputDir: document.getElementById('outputDir').value
    };
    const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'config.json'; a.click();
}

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(item.dataset.section + '-section').classList.add('active');
        const titles = {
            datasets: ['Select Datasets', 'Choose evaluation datasets'],
            configuration: ['Configuration', 'Set models, algorithms, and options'],
            run: ['Run Workflow', 'Review, configure, and run pipeline'],
            dashboard: ['Live Dashboard', 'Monitor running workflows in real-time'],
            agents: ['Agent Roster', 'Configure agents and their model assignments']
        };
        document.getElementById('pageTitle').textContent = titles[item.dataset.section]?.[0] || 'Dashboard';
        document.getElementById('pageSub').textContent = titles[item.dataset.section]?.[1] || '';
        if (item.dataset.section === 'run') updateRunSection();
        if (item.dataset.section === 'dashboard') refreshDashboard();
        if (item.dataset.section === 'agents') initAgentsSection();
    });
});

document.getElementById('nextBtn').addEventListener('click', () => {
    const next = document.querySelector('.nav-item.active').nextElementSibling;
    if (next) next.click();
});

// ============= DASHBOARD FUNCTIONS =============
let dashRuns = [];
let dashSelectedRunId = null;
let dashSelectedStepId = null;
let dashCurrentRun = null;
let dashActiveTab = 'output';
let dashPollInterval = null;

function formatDashDuration(ms) {
    if (!ms) return '--';
    if (ms < 1000) return Math.round(ms) + 'ms';
    if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
    return (ms / 60000).toFixed(1) + 'm';
}

function formatDashTime(iso) {
    if (!iso) return '--';
    return new Date(iso).toLocaleTimeString();
}

function getDashModelTier(modelId) {
    if (!modelId) return 'balanced';
    if (modelId.includes('deepseek-v3') || modelId.includes('671')) return 'power';
    if (modelId.includes('mini') || modelId.includes('fast')) return 'speed';
    return 'balanced';
}

async function refreshDashboard() {
    await loadDashRuns();
    renderDashGrids();
    if (dashSelectedRunId) {
        await loadDashRunDetail(dashSelectedRunId);
        renderDashPipeline();
        if (dashSelectedStepId) renderDashDetail();
    }
}

let dashCurrentView = 'grid';

function setDashView(view) {
    dashCurrentView = view;
    document.querySelectorAll('.dash-view-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.dash-view-btn[data-view="${view}"]`).classList.add('active');
    
    document.getElementById('dashGridView').style.display = view === 'grid' ? 'block' : 'none';
    document.getElementById('dashDetailView').style.display = view === 'detail' ? 'block' : 'none';
    
    if (view === 'detail' && dashSelectedRunId) {
        loadDashRunDetail(dashSelectedRunId).then(() => {
            renderDashRunList();
            renderDashPipeline();
        });
    }
}

function drillDownToRun(runId) {
    dashSelectedRunId = runId;
    dashSelectedStepId = null;
    
    // Update detail view button
    const run = dashRuns.find(r => r.run_id === runId);
    if (run) {
        document.getElementById('detailViewLabel').textContent = run.workflow_name;
        document.getElementById('detailViewBtn').disabled = false;
    }
    
    setDashView('detail');
}

async function loadDashRuns() {
    try {
        const res = await fetch('/api/runs?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            dashRuns = data.runs || [];
        }
    } catch (e) {
        // Try file fallback
        try {
            const res = await fetch('../dashboard_data/runs.json?t=' + Date.now());
            if (res.ok) {
                const data = await res.json();
                dashRuns = data.runs || [];
            }
        } catch (_) {}
    }
}

function renderDashGrids() {
    const running = dashRuns.filter(r => r.status === 'running');
    const completed = dashRuns.filter(r => r.status !== 'running');
    
    // Running workflows
    const runningContainer = document.getElementById('dashRunningGrid');
    if (!running.length) {
        runningContainer.innerHTML = '<div class="dash-empty">No running workflows. Start one from the Run Workflow tab.</div>';
    } else {
        runningContainer.innerHTML = running.map(run => renderWorkflowCard(run)).join('');
    }
    
    // Completed workflows
    const completedContainer = document.getElementById('dashCompletedGrid');
    document.getElementById('completedCount').textContent = completed.length;
    if (!completed.length) {
        completedContainer.innerHTML = '<div class="dash-empty">No completed workflows yet.</div>';
    } else {
        completedContainer.innerHTML = completed.slice(0, 12).map(run => renderWorkflowCard(run)).join('');
    }
}

function renderWorkflowCard(run) {
    const steps = run.steps || [];
    const completedSteps = steps.filter(s => s.status === 'complete').length;
    const totalSteps = steps.length || 1;
    const progress = Math.round((completedSteps / totalSteps) * 100);
    
    return `
        <div class="dash-workflow-card ${run.status}" onclick="drillDownToRun('${run.run_id}')">
            <div class="dash-card-header">
                <div>
                    <div class="dash-card-title">${_escapeHtml(run.workflow_name)}</div>
                    <div class="dash-card-time">${formatDashTime(run.started_at)}</div>
                </div>
                <span class="dash-card-status ${run.status}">${run.status.toUpperCase()}</span>
            </div>
            <div class="dash-card-progress">
                <div class="dash-progress-bar">
                    <div class="dash-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="dash-progress-text">
                    <span>${completedSteps}/${totalSteps} steps</span>
                    <span>${formatDashDuration(run.total_duration_ms || 0)}</span>
                </div>
            </div>
            <div class="dash-card-steps">
                ${steps.slice(0, 8).map((s, i) => `<div class="dash-mini-step ${s.status}" title="${_escapeHtml(s.step_name)}">${i + 1}</div>`).join('')}
                ${steps.length > 8 ? `<div class="dash-mini-step pending">+${steps.length - 8}</div>` : ''}
            </div>
        </div>
    `;
}

function renderDashRunList() {
    const container = document.getElementById('dashRunList');
    if (!dashRuns.length) {
        container.innerHTML = '<div class="dash-empty">No runs yet. Start a workflow to see it here.</div>';
        return;
    }
    container.innerHTML = dashRuns.map(run => `
        <div class="dash-run-item ${run.run_id === dashSelectedRunId ? 'active' : ''}" onclick="selectDashRun('${run.run_id}')">
            <div class="name">${_escapeHtml(run.workflow_name)}</div>
            <div class="time">${formatDashTime(run.started_at)}</div>
            <span class="status ${run.status}">${run.status.toUpperCase()}</span>
        </div>
    `).join('');
}

async function selectDashRun(runId) {
    dashSelectedRunId = runId;
    dashSelectedStepId = null;
    await loadDashRunDetail(runId);
    renderDashRunList();
    renderDashPipeline();
    renderDashDetail();
}

async function loadDashRunDetail(runId) {
    try {
        const res = await fetch('/api/runs/' + runId + '?t=' + Date.now());
        if (res.ok) {
            dashCurrentRun = await res.json();
            return;
        }
    } catch (_) {}
    try {
        const res = await fetch('../dashboard_data/run_' + runId + '.json?t=' + Date.now());
        if (res.ok) {
            dashCurrentRun = await res.json();
        }
    } catch (_) {}
}

function renderDashPipeline() {
    const container = document.getElementById('dashPipeline');
    const header = document.getElementById('dashRunHeader');
    
    if (!dashCurrentRun) {
        container.innerHTML = '<div class="dash-empty">Select a run from the sidebar</div>';
        return;
    }
    
    const r = dashCurrentRun;
    document.getElementById('dashWorkflowName').textContent = r.workflow_name;
    document.getElementById('dashStartTime').textContent = 'Started: ' + formatDashTime(r.started_at);
    document.getElementById('dashDuration').textContent = 'Duration: ' + formatDashDuration(r.total_duration_ms);
    const statusEl = document.getElementById('dashStatus');
    statusEl.textContent = r.status.toUpperCase();
    statusEl.className = 'dash-status-badge ' + r.status;
    
    const steps = r.steps || [];
    if (!steps.length) {
        container.innerHTML = '<div class="dash-empty">No steps yet</div>';
        return;
    }
    
    container.innerHTML = steps.map((step, i) => `
        <div class="dash-step ${step.status} ${step.step_id === dashSelectedStepId ? 'active' : ''}" onclick="selectDashStep('${step.step_id}')">
            <div class="dash-step-num">${i + 1}</div>
            <div class="dash-step-info">
                <div class="dash-step-name">${_escapeHtml(step.step_name)}</div>
                <div class="dash-step-meta">
                    <span>ü§ñ ${_escapeHtml(step.agent_name)}</span>
                    <span class="dash-model-badge ${getDashModelTier(step.model_id)}">${(step.model_id || '--').split(':').pop()}</span>
                </div>
            </div>
            <div class="dash-step-duration">${formatDashDuration(step.duration_ms)}</div>
        </div>
    `).join('');
}

function selectDashStep(stepId) {
    dashSelectedStepId = stepId;
    dashActiveTab = 'output';
    renderDashPipeline();
    renderDashDetail();
}

function setDashTab(tab) {
    dashActiveTab = tab;
    document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.dash-tab[data-tab="${tab}"]`).classList.add('active');
    renderDashDetail();
}

function renderDashDetail() {
    const container = document.getElementById('dashContent');
    
    if (!dashCurrentRun || !dashSelectedStepId) {
        container.innerHTML = '<div class="dash-empty">Click a step to view details</div>';
        return;
    }
    
    const step = (dashCurrentRun.steps || []).find(s => s.step_id === dashSelectedStepId);
    if (!step) return;
    
    document.getElementById('dashStepName').textContent = step.step_name;
    document.getElementById('dashAgentName').textContent = 'Agent: ' + step.agent_name + ' ‚Ä¢ Model: ' + (step.model_id || '--');
    
    if (dashActiveTab === 'stats') {
        container.innerHTML = `
            <div class="dash-stats">
                <div class="dash-stat"><label>Duration</label><div class="value">${formatDashDuration(step.duration_ms)}</div></div>
                <div class="dash-stat"><label>Tokens</label><div class="value">${step.tokens_used || 0}</div></div>
                <div class="dash-stat"><label>Cost</label><div class="value">$${(step.cost_estimate || 0).toFixed(4)}</div></div>
                <div class="dash-stat"><label>Status</label><div class="value">${step.status}</div></div>
            </div>
            ${step.error_message ? `<div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;color:#ef4444;font-size:12px;"><strong>Error:</strong> ${_escapeHtml(step.error_message)}</div>` : ''}
        `;
    } else {
        const content = dashActiveTab === 'output' 
            ? (step.full_output || step.output_preview || 'Waiting for output...') 
            : (step.input_preview || 'No input data...');
        container.innerHTML = `<div class="dash-output">${_escapeHtml(content)}</div>`;
    }
}

// Start polling when on dashboard
function startDashPolling() {
    if (dashPollInterval) return;
    dashPollInterval = setInterval(refreshDashboard, 2000);
}

function stopDashPolling() {
    if (dashPollInterval) {
        clearInterval(dashPollInterval);
        dashPollInterval = null;
    }
}

// Auto-start polling when dashboard is active
const dashObserver = new MutationObserver(() => {
    const dashSection = document.getElementById('dashboard-section');
    if (dashSection && dashSection.classList.contains('active')) {
        startDashPolling();
        refreshDashboard();
    } else {
        stopDashPolling();
    }
});
dashObserver.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['class'] });

// ============= AGENT ROSTER FUNCTIONS =============
let agentAvailableModels = [];
let agentRoster = [];
let editingAgentId = null;

async function loadAgentsFromBackend() {
    try {
        const res = await fetch('/api/agents');
        if (res.ok) {
            const data = await res.json();
            // Sort by workflow
            agentRoster = data.agents || [];
            agentRoster.sort((a,b) => (a._source_workflow || '').localeCompare(b._source_workflow || ''));
        }
    } catch (e) {
        console.error("Failed to load agents", e);
    }
}

async function probeModels() {
    const btn = document.getElementById('probeBtn');
    const chips = document.getElementById('modelChips');
    if(btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading">‚è≥</span> Probing...';
    }
    if(chips) chips.innerHTML = '<span class="model-chip loading">Discovering models...</span>';
    
    try {
        // Trigger probe
        await fetch('/api/models/refresh', { method: 'POST' });
        
        // Poll for results
        for(let i=0; i<5; i++) {
             await new Promise(r => setTimeout(r, 1500));
             const res = await fetch('/api/models');
             if(res.ok) {
                 const data = await res.json();
                 agentAvailableModels = data.models || [];
                 renderModelChips();
                 renderAgentGrid(); 
                 
                 // Sync with Run section models
                 availableModels = [
                    { id: '', label: '(Gold baseline ‚Äî no model call)', selectable: true },
                    ...(agentAvailableModels.map(m => ({ id: String(m.id), label: String(m.id || m.name), selectable: true })))
                 ];
                 if(typeof updatePipeline === 'function') updatePipeline();
             }
        }
    } catch (e) {
        console.error("Probe failed", e);
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Probe Available Models';
        }
    }
}

function renderModelChips() {
    const container = document.getElementById('modelChips');
    const online = agentAvailableModels.filter(m => m.available).length;
    document.getElementById('modelCount').textContent = `${online}/${agentAvailableModels.length} models online`;
    
    container.innerHTML = agentAvailableModels.map(m => `
        <span class="model-chip ${m.available ? 'online' : 'offline'}" title="${m.provider}">
            ${m.available ? '‚úì' : '‚úó'} ${m.name || m.id}
        </span>
    `).join('');
}

function renderAgentGrid() {
    const container = document.getElementById('agentGrid');
    if(!container) return;
    
    const modelOptions = agentAvailableModels.map(m => 
        `<option value="${m.id}" ${!m.available ? 'disabled' : ''}>${m.name || m.id} ${!m.available ? '(offline)' : ''}</option>`
    ).join('');
    
    if (agentRoster.length === 0) {
        container.innerHTML = '<div class="dash-empty">No agents found. API might be offline.</div>';
        return;
    }

    // Group by Workflow
    const grouped = {};
    agentRoster.forEach(a => {
        const wf = a._source_workflow || 'General';
        if (!grouped[wf]) grouped[wf] = [];
        grouped[wf].push(a);
    });

    let html = '';
    for (const [wf, agents] of Object.entries(grouped)) {
        html += `<div style="grid-column: 1/-1; font-weight:600; margin-top:16px; border-bottom:1px solid #333; padding-bottom:4px; color:var(--text-muted);">${wf}</div>`;
        html += agents.map(agent => {
            const role = agent.role || 'Agent';
            const icon = role.toLowerCase().includes('bug') ? 'üêû' : 
                         role.toLowerCase().includes('code') ? 'üíª' : 
                         role.toLowerCase().includes('data') ? 'üíæ' : 'ü§ñ';
            
            return `
                <div class="agent-card" data-agent-id="${agent.id}">
                    <div class="agent-card-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="agent-icon default">${icon}</div>
                            <div>
                                <div class="agent-name">${_escapeHtml(agent.name)}</div>
                                <div class="agent-role">${_escapeHtml(role)}</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px;" onclick="editAgent('${agent.id}')">Edit</button>
                    </div>
                    <div class="agent-config">
                        <div class="agent-config-row">
                            <span class="agent-config-label">Model</span>
                            <span class="agent-config-value">${agent.model}</span>
                        </div>
                         <div class="agent-config-row">
                            <span class="agent-config-label" title="Tools enabled for this agent">Tools</span>
                            <span class="agent-config-value">${(agent.tools || []).length} tools</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    container.innerHTML = html;
}

function editAgent(agentId) {
    const agent = agentRoster.find(a => a.id === agentId);
    if (!agent) return;
    editingAgentId = agentId;
    
    const body = document.getElementById('agentEditBody');
    body.innerHTML = `
        <div class="detail-row">
            <span class="detail-label">Name</span>
            <input type="text" id="editAgentName" class="form-input" value="${_escapeHtml(agent.name)}" disabled style="background:var(--bg-card);">
        </div>
        <div class="detail-row">
            <span class="detail-label">Model</span>
             <select id="editAgentModel" class="form-input">
                <option value="${agent.model}">${agent.model} (Current)</option>
                ${agentAvailableModels.map(m => `<option value="${m.id}">${m.name} (${m.provider})</option>`).join('')}
             </select>
        </div>
        <div class="detail-section">
            <div class="detail-section-title">System Prompt</div>
            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Instructions defining the agent's behavior and persona.</div>
            <textarea id="editAgentPrompt" class="form-input" style="height:200px; font-family:monospace;">${agent.system_prompt || ''}</textarea>
        </div>
        
        <div class="detail-section">
            <div class="detail-section-title">Tools</div>
            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Comma-separated list of tools (e.g. read_file, search_web).</div>
            <input type="text" id="editAgentTools" class="form-input" value="${(agent.tools || []).join(', ')}">
        </div>

        <div class="detail-section">
            <div class="detail-section-title">MCP Servers</div>
            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Comma-separated list of MCP servers (e.g. github, filesystem).</div>
            <input type="text" id="editAgentMCP" class="form-input" value="${(agent.mcp_servers || []).join(', ')}">
        </div>
        
        <div style="display:flex; justify-content:space-between; gap:20px; margin-top:10px;">
            <div style="flex:1">
                 <label style="font-size:12px;display:block;margin-bottom:4px;">Temperature</label>
                 <input type="number" id="editAgentTemp" class="form-input" value="${agent.temperature !== undefined ? agent.temperature : 0.7}" step="0.1" min="0" max="2">
            </div>
             <div style="flex:1">
                 <label style="font-size:12px;display:block;margin-bottom:4px;">Max Tokens</label>
                 <input type="number" id="editAgentTokens" class="form-input" value="${agent.max_tokens || 4096}" step="128">
            </div>
        </div>
    `;
    
    document.getElementById('agentEditModal').classList.add('active');
}

function updateAgentModel(agentId, modelId) {
    const agent = agentRoster.find(a => a.id === agentId);
    if (agent) {
        agent.current_model = modelId;
        console.log(`Updated ${agent.name} to use model: ${modelId}`);
    }
}

async function saveAgentEdit() {
    if (!editingAgentId) return;
    
    // Gather data
    const payload = {
        id: editingAgentId,
        model: document.getElementById('editAgentModel').value,
        system_prompt: document.getElementById('editAgentPrompt').value,
        temperature: parseFloat(document.getElementById('editAgentTemp').value),
        max_tokens: parseInt(document.getElementById('editAgentTokens').value),
        tools: document.getElementById('editAgentTools').value.split(',').map(s=>s.trim()).filter(s=>s),
        mcp_servers: document.getElementById('editAgentMCP').value.split(',').map(s=>s.trim()).filter(s=>s)
    };
    
    try {
        const res = await fetch('/api/agents/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (res.ok) {
            closeAgentEditModal();
            // Refetch to see changes
            await loadAgentsFromBackend();
            renderAgentGrid();
            alert("Agent updated successfully!");
        } else {
            const err = await res.json();
            alert("Update failed: " + (err.error || "Unknown"));
        }
    } catch (e) {
        alert("Error saving: " + e.message);
    }
}

// Initialize agents section when visible
function initAgentsSection() {
    loadAgentsFromBackend().then(() => {
        probeModels();
    });
}

loadDatasets();
renderScoring();
updatePipeline();

checkApiNow(false).then(() => loadModels());
setInterval(() => checkApiNow(false), 3000);
</script>
</script>
<div class="modal" id="agentEditModal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>Edit Agent Configuration</h3>
            <button class="close-btn" onclick="closeAgentEditModal()">&times;</button>
        </div>
        <div class="modal-body" id="agentEditBody">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAgentEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveAgentEdit()">Save Changes</button>
        </div>
    </div>
</div>
</body>
</html>
